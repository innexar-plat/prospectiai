{"version":3,"sources":["../../../../backend/src/lib/logger.ts","../../../../backend/src/lib/email-config-encrypt.ts","../../../../backend/src/lib/notification-service.ts"],"sourcesContent":["/**\n * Logger estruturado (JSON) para observabilidade.\n * Níveis: info, warn, error. Suporta requestId/correlationId opcional.\n */\n\nexport type LogLevel = 'info' | 'warn' | 'error';\n\nexport interface LogContext {\n  level: LogLevel;\n  message: string;\n  requestId?: string;\n  [key: string]: unknown;\n}\n\nconst LOG_LEVEL_ORDER: Record<LogLevel, number> = {\n  info: 0,\n  warn: 1,\n  error: 2,\n};\n\nconst minLevel: LogLevel = process.env.LOG_LEVEL === 'error' ? 'error' : 'info';\n\nfunction shouldLog(level: LogLevel): boolean {\n  return LOG_LEVEL_ORDER[level] >= LOG_LEVEL_ORDER[minLevel];\n}\n\nfunction write(level: LogLevel, message: string, meta?: Record<string, unknown>, requestId?: string): void {\n  if (!shouldLog(level)) return;\n  const payload: LogContext = {\n    level,\n    message,\n    timestamp: new Date().toISOString(),\n    ...(requestId && { requestId }),\n    ...meta,\n  };\n  const line = JSON.stringify(payload);\n  if (level === 'error') {\n    process.stderr.write(line + '\\n');\n  } else {\n    process.stdout.write(line + '\\n');\n  }\n}\n\nexport const logger = {\n  info(message: string, meta?: Record<string, unknown>, requestId?: string): void {\n    write('info', message, meta, requestId);\n  },\n  warn(message: string, meta?: Record<string, unknown>, requestId?: string): void {\n    write('warn', message, meta, requestId);\n  },\n  error(message: string, meta?: Record<string, unknown>, requestId?: string): void {\n    write('error', message, meta, requestId);\n  },\n};\n\n/** Obtém requestId do header x-request-id ou gera um (para uso em rotas). */\nexport function getRequestId(req: { headers: { get: (name: string) => string | null } }): string | undefined {\n  const id = req.headers.get('x-request-id');\n  if (id && typeof id === 'string') return id;\n  return undefined;\n}\n","/**\n * Encrypt/decrypt email config secrets (Resend API key, SMTP password).\n * Uses AES-256-GCM; key derived from AI_CONFIG_ENCRYPTION_KEY or AUTH_SECRET.\n * Never log or return raw values.\n */\n\nimport { createCipheriv, createDecipheriv, randomBytes, scryptSync } from 'crypto';\n\nconst ALG = 'aes-256-gcm';\nconst KEY_LEN = 32;\nconst IV_LEN = 16;\nconst TAG_LEN = 16;\nconst SALT = 'email-config-salt';\n\nfunction getEncryptionKey(): Buffer {\n  const secret = process.env.AI_CONFIG_ENCRYPTION_KEY || process.env.AUTH_SECRET;\n  if (!secret || secret.length < 16) {\n    throw new Error(\n      'AI_CONFIG_ENCRYPTION_KEY or AUTH_SECRET (min 16 chars) required for email config encryption'\n    );\n  }\n  return scryptSync(secret, SALT, KEY_LEN);\n}\n\nexport function encryptEmailSecret(plaintext: string): string {\n  const key = getEncryptionKey();\n  const iv = randomBytes(IV_LEN);\n  const cipher = createCipheriv(ALG, key, iv);\n  const enc = Buffer.concat([cipher.update(plaintext, 'utf8'), cipher.final()]);\n  const tag = cipher.getAuthTag();\n  return Buffer.concat([iv, tag, enc]).toString('hex');\n}\n\nexport function decryptEmailSecret(encryptedHex: string): string {\n  const key = getEncryptionKey();\n  const buf = Buffer.from(encryptedHex, 'hex');\n  if (buf.length < IV_LEN + TAG_LEN) throw new Error('Invalid encrypted value');\n  const iv = buf.subarray(0, IV_LEN);\n  const tag = buf.subarray(IV_LEN, IV_LEN + TAG_LEN);\n  const ciphertext = buf.subarray(IV_LEN + TAG_LEN);\n  const decipher = createDecipheriv(ALG, key, iv);\n  decipher.setAuthTag(tag);\n  return decipher.update(ciphertext).toString('utf8') + decipher.final('utf8');\n}\n","/**\n * Notification service: create in-app notifications and optionally send email by user preference.\n * When channel is provided, NotificationChannelConfig is respected (appEnabled / emailEnabled).\n */\n\nimport { prisma } from '@/lib/prisma';\nimport { sendEmail } from '@/lib/email';\nimport { notificationTemplate } from '@/lib/email-templates';\nimport type { NotificationType } from '@prisma/client';\n\n/** Known notification channels (key + display name). Config stored in NotificationChannelConfig. */\nexport const NOTIFICATION_CHANNELS: ReadonlyArray<{ key: string; name: string }> = [\n  { key: 'lead_analysis_ready', name: 'Análise de lead pronta' },\n  { key: 'team_invite', name: 'Convite para workspace' },\n  { key: 'admin_broadcast', name: 'Broadcast admin' },\n];\n\nexport interface CreateNotificationInput {\n  userId: string;\n  workspaceId?: string | null;\n  title: string;\n  message: string;\n  type?: NotificationType;\n  link?: string | null;\n  /** If true, send email when user has notifyByEmail and channel allows email. */\n  sendEmailIfPreferred?: boolean;\n  /** Optional email subject when sending email. */\n  emailSubject?: string;\n  /** Channel key: if set, app/email are gated by NotificationChannelConfig. */\n  channel?: string;\n}\n\nasync function getChannelConfig(key: string): Promise<{ appEnabled: boolean; emailEnabled: boolean }> {\n  const row = await prisma.notificationChannelConfig.findUnique({\n    where: { key },\n    select: { appEnabled: true, emailEnabled: true },\n  });\n  return row\n    ? { appEnabled: row.appEnabled, emailEnabled: row.emailEnabled }\n    : { appEnabled: true, emailEnabled: true };\n}\n\n/** For admin API: list all known channels with their DB config (defaults true if no row). */\nexport async function getChannelsWithConfig(): Promise<\n  Array<{ key: string; name: string; appEnabled: boolean; emailEnabled: boolean }>\n> {\n  const rows = await prisma.notificationChannelConfig.findMany({\n    select: { key: true, appEnabled: true, emailEnabled: true },\n  });\n  const map = new Map(rows.map((r) => [r.key, { appEnabled: r.appEnabled, emailEnabled: r.emailEnabled }]));\n  return NOTIFICATION_CHANNELS.map((ch) => {\n    const config = map.get(ch.key) ?? { appEnabled: true, emailEnabled: true };\n    return { key: ch.key, name: ch.name, appEnabled: config.appEnabled, emailEnabled: config.emailEnabled };\n  });\n}\n\n/**\n * Create a notification for a user. Optionally send email when user has notifyByEmail.\n * If channel is set, respects NotificationChannelConfig (appEnabled / emailEnabled).\n */\nexport async function createNotification(input: CreateNotificationInput): Promise<{ id: string }> {\n  const {\n    userId,\n    workspaceId,\n    title,\n    message,\n    type = 'INFO',\n    link,\n    sendEmailIfPreferred = false,\n    emailSubject,\n    channel,\n  } = input;\n\n  let appEnabled = true;\n  let emailEnabled = true;\n  if (channel) {\n    const config = await getChannelConfig(channel);\n    appEnabled = config.appEnabled;\n    emailEnabled = config.emailEnabled;\n  }\n\n  let notificationId = '';\n  if (appEnabled) {\n    const notification = await prisma.notification.create({\n      data: {\n        userId,\n        workspaceId: workspaceId ?? undefined,\n        title,\n        message,\n        type,\n        link: link ?? undefined,\n      },\n      select: { id: true },\n    });\n    notificationId = notification.id;\n  }\n\n  const shouldSendEmail = sendEmailIfPreferred && emailEnabled;\n  if (shouldSendEmail) {\n    const user = await prisma.user.findUnique({\n      where: { id: userId },\n      select: { email: true, notifyByEmail: true },\n    });\n    if (user?.email && user.notifyByEmail) {\n      const subject = emailSubject ?? title;\n      const html = notificationTemplate(title, message, link);\n      void sendEmail(user.email, subject, html);\n    }\n  }\n\n  return { id: notificationId };\n}\n\n/**\n * Create a notification for every user (e.g. admin broadcast).\n * If channel is provided (e.g. admin_broadcast), respects NotificationChannelConfig.\n * When emailEnabled, sends email to each user with notifyByEmail.\n */\nexport async function createNotificationForAllUsers(input: {\n  title: string;\n  message: string;\n  type?: NotificationType;\n  link?: string | null;\n  channel?: string;\n  emailSubject?: string;\n}): Promise<{ count: number }> {\n  const users = await prisma.user.findMany({\n    where: { email: { not: null }, disabledAt: null },\n    select: { id: true, email: true, notifyByEmail: true },\n  });\n\n  let appEnabled = true;\n  let emailEnabled = false;\n  if (input.channel) {\n    const config = await getChannelConfig(input.channel);\n    appEnabled = config.appEnabled;\n    emailEnabled = config.emailEnabled;\n  }\n\n  if (appEnabled) {\n    await prisma.notification.createMany({\n      data: users.map((u) => ({\n        userId: u.id,\n        title: input.title,\n        message: input.message,\n        type: input.type ?? 'SYSTEM',\n        link: input.link ?? undefined,\n      })),\n    });\n  }\n\n  if (emailEnabled) {\n    const subject = input.emailSubject ?? input.title;\n    const html = notificationTemplate(input.title, input.message, input.link ?? undefined);\n    for (const u of users) {\n      if (u.email && u.notifyByEmail) {\n        void sendEmail(u.email, subject, html);\n      }\n    }\n  }\n\n  return { count: users.length };\n}\n"],"names":[],"mappings":"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"}
{"version":3,"sources":["../../../../backend/src/lib/usage.ts"],"sourcesContent":["/**\n * Usage event recording for admin dashboard metrics.\n * Fire-and-forget: does not block the request; errors are logged only.\n */\n\nimport { prisma } from '@/lib/prisma';\nimport type { UsageEventType } from '@prisma/client';\n\nexport interface RecordUsageOptions {\n  workspaceId: string;\n  userId?: string | null;\n  type: UsageEventType;\n  quantity?: number;\n  metadata?: Record<string, unknown>;\n}\n\nexport interface WorkspaceUsage {\n  googlePlacesSearch: number;\n  googlePlacesDetails: number;\n  serperRequests: number;\n  aiInputTokens: number;\n  aiOutputTokens: number;\n}\n\n/**\n * Record a usage event (Google Places, Serper, AI tokens).\n * Runs in background; does not throw.\n */\nexport function recordUsageEvent(options: RecordUsageOptions): void {\n  const { workspaceId, userId, type, quantity = 1, metadata } = options;\n  void prisma.usageEvent\n    .create({\n      data: {\n        workspaceId,\n        userId: userId ?? undefined,\n        type,\n        quantity,\n        metadata: metadata ? (metadata as object) : undefined,\n      },\n    })\n    .catch((err) => {\n      import('@/lib/logger').then(({ logger }) =>\n        logger.warn('Usage event record failed', { workspaceId, type, error: err instanceof Error ? err.message : 'Unknown' })\n      );\n    });\n}\n\n/**\n * Get aggregated usage for one or more workspaces.\n */\nexport async function getWorkspaceUsage(workspaceIds: string[]): Promise<Map<string, WorkspaceUsage>> {\n  if (workspaceIds.length === 0) return new Map();\n  const defaultUsage: WorkspaceUsage = {\n    googlePlacesSearch: 0,\n    googlePlacesDetails: 0,\n    serperRequests: 0,\n    aiInputTokens: 0,\n    aiOutputTokens: 0,\n  };\n  const map = new Map<string, WorkspaceUsage>(workspaceIds.map((id) => [id, { ...defaultUsage }]));\n\n  const nonAi = await prisma.usageEvent.groupBy({\n    by: ['workspaceId', 'type'],\n    where: { workspaceId: { in: workspaceIds }, type: { not: 'AI_TOKENS' } },\n    _sum: { quantity: true },\n  });\n  for (const row of nonAi) {\n    const u = map.get(row.workspaceId)!;\n    const sum = row._sum.quantity ?? 0;\n    if (row.type === 'GOOGLE_PLACES_SEARCH') u.googlePlacesSearch = sum;\n    else if (row.type === 'GOOGLE_PLACES_DETAILS') u.googlePlacesDetails = sum;\n    else if (row.type === 'SERPER_REQUEST') u.serperRequests = sum;\n  }\n\n  const aiEvents = await prisma.usageEvent.findMany({\n    where: { workspaceId: { in: workspaceIds }, type: 'AI_TOKENS' },\n    select: { workspaceId: true, metadata: true },\n  });\n  for (const e of aiEvents) {\n    const u = map.get(e.workspaceId)!;\n    const m = e.metadata as { inputTokens?: number; outputTokens?: number } | null;\n    if (m) {\n      u.aiInputTokens += Number(m.inputTokens) || 0;\n      u.aiOutputTokens += Number(m.outputTokens) || 0;\n    }\n  }\n  return map;\n}\n"],"names":[],"mappings":"uCAKA,IAAA,EAAA,EAAA,CAAA,CAAA,OAuBO,SAAS,EAAiB,CAA2B,EAC1D,GAAM,aAAE,CAAW,QAAE,CAAM,CAAE,MAAI,CAAE,WAAW,CAAC,UAAE,CAAQ,CAAE,CAAG,EACzD,EAAA,MAAM,CAAC,UAAU,CACnB,MAAM,CAAC,CACN,KAAM,aACJ,EACA,OAAQ,GAAU,YAClB,WACA,EACA,SAAU,QAAkC,CAC9C,CACF,CAF0B,EAGzB,KAAK,CAAC,AAAC,IACN,EAAA,CAAA,CAAA,OAAuB,IAAI,CAAC,CAAC,QAAE,CAAM,CAAE,GACrC,EAAO,IAAI,CAAC,4BAA6B,aAAE,OAAa,EAAM,MAAO,aAAe,MAAQ,EAAI,OAAO,CAAG,SAAU,GAExH,EACJ,CAKO,eAAe,EAAkB,CAAsB,EAC5D,GAA4B,IAAxB,EAAa,MAAM,CAAQ,OAAO,IAAI,IAC1C,IAAM,EAA+B,CACnC,mBAAoB,EACpB,oBAAqB,EACrB,eAAgB,EAChB,cAAe,EACf,eAAgB,CAClB,EACM,EAAM,IAAI,IAA4B,EAAa,GAAG,CAAC,AAAC,GAAO,CAAC,EAAI,CAAE,GAAG,CAAY,AAAC,EAAE,GAO9F,IAAK,IAAM,KALG,EAKI,IALE,EAAA,MAAM,CAAC,UAAU,CAAC,OAAO,CAAC,CAC5C,GAAI,CAAC,cAAe,OAAO,CAC3B,MAAO,CAAE,YAAa,CAAE,GAAI,CAAa,EAAG,KAAM,CAAE,IAAK,WAAY,CAAE,EACvE,KAAM,CAAE,UAAU,CAAK,CACzB,EAAA,EACyB,CACvB,IAAM,EAAI,EAAI,GAAG,CAAC,EAAI,WAAW,EAC3B,EAAM,EAAI,IAAI,CAAC,QAAQ,EAAI,EAChB,yBAAb,EAAI,IAAI,CAA6B,EAAE,kBAAkB,CAAG,EAC1C,0BAAb,EAAI,IAAI,CAA8B,EAAE,mBAAmB,CAAG,EACjD,mBAAb,EAAI,IAAI,GAAuB,EAAE,cAAc,CAAG,CAAA,CAC7D,CAMA,IAAK,IAAM,KAJM,AAID,MAJO,EAAA,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,CAChD,MAAO,CAAE,YAAa,CAAE,GAAI,CAAa,EAAG,KAAM,WAAY,EAC9D,OAAQ,CAAE,aAAa,EAAM,UAAU,CAAK,CAC9C,EAAA,EAC0B,CACxB,IAAM,EAAI,EAAI,GAAG,CAAC,EAAE,WAAW,EACzB,EAAI,EAAE,QAAQ,CAChB,GAAG,CACL,EAAE,aAAa,EAAI,OAAO,EAAE,WAAW,GAAK,EAC5C,EAAE,cAAc,EAAI,OAAO,EAAE,YAAY,GAAK,EAElD,CACA,OAAO,CACT"}
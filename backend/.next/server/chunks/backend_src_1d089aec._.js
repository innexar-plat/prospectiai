module.exports=[17059,77842,e=>{"use strict";let t=/(?:\+55\s*)?(?:\(?\d{2}\)?\s*)?9\d{4}[\s-]?\d{4}/;function a(e){return(e.nationalPhoneNumber||e.internationalPhoneNumber||e.phone||"").trim()}function r(e){return(e.websiteUri||e.website||"").trim()}function i(e){return e.userRatingCount??e.reviewCount??0}function n(e,s=20){let o=e.map(e=>i(e)).filter(e=>e>0).sort((e,t)=>t-e).slice(0,10),l=o.length>0?o[Math.floor(o.length/2)]:0,c=e.map(e=>e.rating).filter(e=>null!=e&&e>0),d=c.length>0?Math.round(c.reduce((e,t)=>e+t,0)/c.length*10)/10:null;return{scored:e.map(e=>{let n,s=function(e,n=0){let s=r(e),o=a(e),l=e.rating??0,c=i(e);return{noWebsite:!s,noPhone:!o,lowRating:l>0&&l<3.5,fewReviews:c<10,lowReviewsVsMedian:n>0&&c<.3*n,mobilePhoneAvailable:t.test(o),operational:(e.businessStatus??"OPERATIONAL")==="OPERATIONAL"}}(e,l);return{id:String(e.id??""),name:(e.displayName?.text||e.name||"").trim(),score:(n=0,s.noWebsite&&(n+=25),s.noPhone&&(n+=15),s.lowRating&&(n+=15),s.fewReviews&&(n+=20),s.lowReviewsVsMedian&&(n+=10),s.mobilePhoneAvailable&&(n+=5),s.operational&&(n+=5),Math.min(100,Math.max(0,n))),scoreFactors:s,formattedAddress:e.formattedAddress,phone:a(e)||void 0,website:r(e)||void 0,rating:e.rating??void 0,reviewCount:i(e)||void 0,primaryType:e.primaryType??(Array.isArray(e.types)?e.types[0]:void 0)}}).filter(e=>e.id&&e.name).sort((e,t)=>t.score-e.score).slice(0,s),medianReviews:l,avgRating:d}}e.s(["scoreAndRankPlaces",()=>n],77842),e.s([],17059)},21564,71998,e=>{"use strict";var t=e.i(99612),a=e.i(71586),r=e.i(12321);let i={lead_analysis:"gemini-flash-latest",viability:"gemini-2.5-flash",company_analysis:"gemini-2.5-flash"};async function n(e){let n=await l(e);if(n||"viability"!==e&&"company_analysis"!==e||(n=await l("company_analysis"===e?"viability":"lead_analysis")),n){let e=function(e,i,n,s){switch(e){case"GEMINI":return(0,t.createGeminiAdapter)(n,i);case"OPENAI":return(0,a.createOpenAIAdapter)(n,i);case"CLOUDFLARE":return(0,r.createCloudflareAdapter)(n,i,s);default:throw Error(`Unknown AI provider: ${e}`)}}(n.provider,n.model,n.apiKey,n.accountId);return{config:{provider:n.provider,model:n.model,apiKey:n.apiKey},adapter:e}}let s=process.env.GEMINI_API_KEY;if(!s)throw Error(`No AI config for role "${e}" and GEMINI_API_KEY not set`);let o=i[e],c=(0,t.createGeminiAdapter)(s,o);return{config:{provider:"GEMINI",model:o,apiKey:s},adapter:c}}async function s(e,t){let{adapter:a}=await n(e);return a.generateCompletion(t)}let o={lead_analysis:"LEAD_ANALYSIS",viability:"VIABILITY",company_analysis:"COMPANY_ANALYSIS"};async function l(t){try{let{prisma:a}=await e.A(10906),{decryptApiKey:r}=await e.A(99913),i=o[t],n=await a.aiProviderConfig.findFirst({where:{role:i,enabled:!0},orderBy:{updatedAt:"desc"}});if(!n||!n.apiKeyEncrypted)return null;let s=r(n.apiKeyEncrypted);return{provider:n.provider,model:n.model,apiKey:s,accountId:n.cloudflareAccountId??void 0}}catch{return null}}e.s(["generateCompletionForRole",()=>s,"resolveAiForRole",()=>n],71998),e.s([],21564)},87040,e=>{"use strict";async function t(e,a,r=5){let i=await fetch("https://google.serper.dev/search",{method:"POST",headers:{"X-API-KEY":e,"Content-Type":"application/json"},body:JSON.stringify({q:a,num:r})});if(!i.ok){let e=await i.text();throw Error(`Serper API error ${i.status}: ${e}`)}return((await i.json()).organic??[]).slice(0,r).map(e=>({title:e.title??"",link:e.link??"",snippet:e.snippet}))}let a={lead_analysis:"LEAD_ANALYSIS",viability:"VIABILITY",company_analysis:"COMPANY_ANALYSIS"};async function r(t){try{let{prisma:r}=await e.A(10906),{decryptApiKey:i}=await e.A(99913),n=a[t],s=await r.webSearchConfig.findUnique({where:{role:n}});if(!s||!s.enabled||!s.apiKeyEncrypted)return null;let o=i(s.apiKeyEncrypted);return{provider:s.provider,apiKey:o,maxResults:s.maxResults??5}}catch{return null}}async function i(a,i,n){let s=await r(a);if(!s||0===i.length)return"";let o=[],l=0;for(let e of i.slice(0,"company_analysis"===a?6:5)){if(!e.trim())continue;let{label:a,emoji:r}=function(e){let t=e.toLowerCase();return t.includes("reclame aqui")?{label:"Reclame Aqui â€” ReputaÃ§Ã£o do Consumidor",emoji:"ðŸ”´"}:t.includes("jusbrasil")?{label:"JusBrasil â€” Processos Judiciais",emoji:"âš–ï¸"}:t.includes("cnpj")?{label:"CNPJ â€” Dados Empresariais",emoji:"ðŸ¢"}:t.includes("instagram")?{label:"Redes sociais â€” Instagram",emoji:"ðŸ“±"}:t.includes("facebook")?{label:"Redes sociais â€” Facebook",emoji:"ðŸ“±"}:t.includes("linkedin")?{label:"Redes sociais â€” LinkedIn",emoji:"ðŸ“±"}:t.includes("avaliaÃ§Ãµes google")||t.includes("google reviews")?{label:"AvaliaÃ§Ãµes Google",emoji:"â­"}:{label:`Busca Web â€” "${e}"`,emoji:"ðŸ”"}}(e),i={label:a,emoji:r,items:[]};try{if("SERPER"===s.provider){let a=await t(s.apiKey,e.trim(),Math.min(s.maxResults,5));for(let e of(l+=1,a))i.items.push({title:e.title,link:e.link,snippet:e.snippet??""})}}catch{}o.push(i)}if(n?.workspaceId&&l>0){let{recordUsageEvent:t}=await e.A(82269);t({workspaceId:n.workspaceId,userId:n.userId??void 0,type:"SERPER_REQUEST",quantity:l})}let c=function(e){let t=[];for(let a of e)if(0!==a.items.length){for(let e of(t.push(`### ${a.emoji} ${a.label}`),a.items))t.push(`- **${e.title}** â€” [${e.link}](${e.link})`),e.snippet&&t.push(`  ${e.snippet}`);t.push("")}return t.join("\n")}(o);return c.trim()?`## ðŸ“Š Contexto da Web (dados reais coletados â€” use-os na an\xe1lise e cite as fontes)

${c}`:""}e.s(["getWebContextForRole",()=>i],87040)},10266,e=>{"use strict";var t=e.i(49292);async function a(e,r,i="Brasil"){let n,s=process.env.GOOGLE_PLACES_API_KEY;if(!s)return null;let o=[e.trim()];r?.trim()&&o.push(r.trim()),o.push(i);let l=o.join(", "),c=(n=i.trim().toLowerCase()).includes("brasil")||"br"===n?"br":n.includes("argentina")||"ar"===n?"ar":n.includes("mÃ©xico")||n.includes("mexico")||"mx"===n?"mx":n.includes("estados unidos")||n.includes("united states")||"us"===n?"us":n.includes("portugal")||"pt"===n?"pt":n.includes("espanha")||n.includes("spain")||"es"===n?"es":"br",d=new URL("https://maps.googleapis.com/maps/api/geocode/json");d.searchParams.set("address",l),d.searchParams.set("key",s),d.searchParams.set("region",c),d.searchParams.set("language","pt-BR");let u=await (0,t.fetchWithRetry)(d.toString(),{method:"GET"},{timeoutMs:1e4,maxRetries:2});if(!u.ok)return null;let p=await u.json();if("OK"!==p.status||!p.results?.[0]?.geometry?.location)return null;let g=p.results[0].geometry.location,m=g.lat,h=g.lng;return"number"!=typeof m||"number"!=typeof h?null:{latitude:m,longitude:h}}e.s(["geocodeAddress",()=>a])},45881,e=>{"use strict";let t={FREE:["MAPEAMENTO","INTELIGENCIA_LEADS"],BASIC:["MAPEAMENTO","INTELIGENCIA_LEADS"],PRO:["MAPEAMENTO","INTELIGENCIA_LEADS","ANALISE_CONCORRENCIA","ACAO_COMERCIAL"],BUSINESS:["MAPEAMENTO","INTELIGENCIA_MERCADO","ANALISE_CONCORRENCIA","ANALISE_MINHA_EMPRESA","INTELIGENCIA_LEADS","ACAO_COMERCIAL"],SCALE:["MAPEAMENTO","INTELIGENCIA_MERCADO","ANALISE_CONCORRENCIA","ANALISE_MINHA_EMPRESA","INTELIGENCIA_LEADS","ACAO_COMERCIAL"]};function a(e){return t[e]??t.FREE}function r(e,t){return a(e).includes(t)}e.s(["MODULES",0,{MAPEAMENTO:{key:"MAPEAMENTO",name:"Mapeamento",shortDescription:"Buscar empresas por nicho e regiÃ£o",features:["Buscar empresas por nicho","Filtrar por regiÃ£o","Filtros por site e telefone","Lista de resultados paginada"],deliverables:["Lista estruturada de empresas","HistÃ³rico de buscas"],backendStatus:"done"},INTELIGENCIA_MERCADO:{key:"INTELIGENCIA_MERCADO",name:"InteligÃªncia de Mercado",shortDescription:"AnÃ¡lise de mercado local e tendÃªncias por regiÃ£o",features:["Quantidade de empresas por segmento","Crescimento por categoria na regiÃ£o","SaturaÃ§Ã£o da regiÃ£o","Ticket mÃ©dio estimado","Score de maturidade digital"],deliverables:["RelatÃ³rio de mercado automÃ¡tico","AnÃ¡lise comparativa por bairro","TendÃªncia local"],backendStatus:"partial"},ANALISE_CONCORRENCIA:{key:"ANALISE_CONCORRENCIA",name:"AnÃ¡lise de ConcorrÃªncia",shortDescription:"Ranking e gaps vs concorrentes no raio",features:["Quantos concorrentes no raio","Quem tem mais avaliaÃ§Ãµes","PresenÃ§a digital (site, redes)","Quem nÃ£o tem site / redes","Ranking competitivo"],deliverables:["Score competitivo","Gap analysis","Lista de oportunidades"],backendStatus:"partial"},ANALISE_MINHA_EMPRESA:{key:"ANALISE_MINHA_EMPRESA",name:"AnÃ¡lise da minha empresa",shortDescription:"DiagnÃ³stico da prÃ³pria empresa com Reclame Aqui, Google, redes sociais e IA",features:["ReputaÃ§Ã£o Reclame Aqui e reclamaÃ§Ãµes","AvaliaÃ§Ãµes Google (rating e reviews)","PresenÃ§a em redes sociais (link + dados pÃºblicos)","Oportunidades e nicho sugerido","Modelo de negÃ³cio sugerido"],deliverables:["RelatÃ³rio de anÃ¡lise da empresa","SeÃ§Ã£o redes sociais","RecomendaÃ§Ãµes e prÃ³ximos passos"],backendStatus:"done"},INTELIGENCIA_LEADS:{key:"INTELIGENCIA_LEADS",name:"InteligÃªncia de Leads",shortDescription:"Score e classificaÃ§Ã£o de potencial do lead",features:["Score de investimento","Score de urgÃªncia","ClassificaÃ§Ã£o frio / morno / quente","Potencial financeiro","Probabilidade de compra"],deliverables:["Ranking de leads","Filtro por potencial","SugestÃ£o de abordagem"],backendStatus:"partial"},ACAO_COMERCIAL:{key:"ACAO_COMERCIAL",name:"AÃ§Ã£o Comercial",shortDescription:"Abordagem pronta para contato",features:["Script de ligaÃ§Ã£o personalizado","E-mail pronto","Mensagem WhatsApp","Pitch adaptado ao nicho","SequÃªncia de follow-up"],deliverables:["Lead pronto para contato","Economia de tempo","Maior conversÃ£o"],backendStatus:"partial"}},"getModulesForPlan",()=>a,"planHasModule",()=>r])},98936,e=>{"use strict";var t=e.i(78787);async function a(a){try{return await t.prisma.lead.upsert({where:{placeId:a.id},update:{name:a.displayName.text,address:a.formattedAddress,phone:a.nationalPhoneNumber||a.internationalPhoneNumber,website:a.websiteUri,rating:a.rating,reviewCount:a.userRatingCount,types:a.types||[],businessStatus:a.businessStatus,lastSearchedAt:new Date},create:{placeId:a.id,name:a.displayName.text,address:a.formattedAddress,phone:a.nationalPhoneNumber||a.internationalPhoneNumber,website:a.websiteUri,rating:a.rating,reviewCount:a.userRatingCount,types:a.types||[],businessStatus:a.businessStatus}})}catch(r){let{logger:t}=await e.A(31443);return t.error("Error syncing lead",{placeId:a.id,error:r instanceof Error?r.message:"Unknown"}),null}}async function r(e){return Promise.all(e.map(a))}e.s(["syncLead",()=>a,"syncLeads",()=>r])},44730,e=>{"use strict";var t=e.i(42512);let a=null;function r(){if(a)return a;let e=process.env.REDIS_URL||"redis://localhost:6379";try{return(a=new t.default(e,{maxRetriesPerRequest:1,retryStrategy:e=>e>2?null:Math.min(200*e,1e3),lazyConnect:!0})).on("error",()=>{a=null}),a}catch{return null}}async function i(e){try{let t=r();if(!t)return null;await t.connect().catch(()=>{});let a=await t.get(e);if(!a)return null;return JSON.parse(a)}catch{return null}}async function n(e,t,a=300){try{let i=r();if(!i)return;await i.connect().catch(()=>{}),await i.set(e,JSON.stringify(t),"EX",a)}catch{}}e.s(["getCached",()=>i,"setCached",()=>n])},84680,e=>{"use strict";var t=e.i(78787);function a(a){let{workspaceId:r,userId:i,type:n,quantity:s=1,metadata:o}=a;t.prisma.usageEvent.create({data:{workspaceId:r,userId:i??void 0,type:n,quantity:s,metadata:o||void 0}}).catch(t=>{e.A(31443).then(({logger:e})=>e.warn("Usage event record failed",{workspaceId:r,type:n,error:t instanceof Error?t.message:"Unknown"}))})}async function r(e){if(0===e.length)return new Map;let a={googlePlacesSearch:0,googlePlacesDetails:0,serperRequests:0,aiInputTokens:0,aiOutputTokens:0},r=new Map(e.map(e=>[e,{...a}]));for(let a of(await t.prisma.usageEvent.groupBy({by:["workspaceId","type"],where:{workspaceId:{in:e},type:{not:"AI_TOKENS"}},_sum:{quantity:!0}}))){let e=r.get(a.workspaceId),t=a._sum.quantity??0;"GOOGLE_PLACES_SEARCH"===a.type?e.googlePlacesSearch=t:"GOOGLE_PLACES_DETAILS"===a.type?e.googlePlacesDetails=t:"SERPER_REQUEST"===a.type&&(e.serperRequests=t)}for(let a of(await t.prisma.usageEvent.findMany({where:{workspaceId:{in:e},type:"AI_TOKENS"},select:{workspaceId:!0,metadata:!0}}))){let e=r.get(a.workspaceId),t=a.metadata;t&&(e.aiInputTokens+=Number(t.inputTokens)||0,e.aiOutputTokens+=Number(t.outputTokens)||0)}return r}e.s(["getWorkspaceUsage",()=>r,"recordUsageEvent",()=>a])},43757,49292,e=>{"use strict";function t(e){return new Promise(t=>setTimeout(t,e))}let a=e=>429===e||e>=500&&e<600;async function r(e,i,n={}){let{timeoutMs:s=15e3,maxRetries:o=3,initialBackoffMs:l=1e3,retryStatuses:c=a}=n,d=null,u=null;for(let a=0;a<=o;a++){let r=new AbortController,n=setTimeout(()=>r.abort(),s),p={...i,signal:r.signal};try{let r=await fetch(e,p);if(clearTimeout(n),d=r,a<o&&c(r.status)){let e=l*Math.pow(2,a);await t(e);continue}return r}catch(e){if(clearTimeout(n),u=e instanceof Error?e:Error(String(e)),a<o){let e=l*Math.pow(2,a);await t(e);continue}throw u}}if(d)return d;throw u??Error("fetchWithRetry failed")}e.s(["fetchWithRetry",()=>r],49292);let i="https://places.googleapis.com/v1/places",n=new Map;async function s(e){let t,a=process.env.GOOGLE_PLACES_API_KEY;if(!a)throw Error("GOOGLE_PLACES_API_KEY not configured");let s=Math.min(20,Math.max(1,e.pageSize??20));if(e.pageToken){let a=n.get(e.pageToken);t=a?{...a.body,pageToken:e.pageToken}:{textQuery:e.textQuery,pageSize:s,languageCode:e.languageCode||"pt-BR",regionCode:e.regionCode||"BR",pageToken:e.pageToken}}else if(t={textQuery:e.textQuery,pageSize:s,languageCode:e.languageCode||"pt-BR",regionCode:e.regionCode||"BR"},e.includedType&&(t.includedType=e.includedType),e.locationBias?.center&&e.locationBias?.radius!=null){let a=Math.min(5e4,Math.max(0,e.locationBias.radius));t.locationBias={circle:{center:{latitude:e.locationBias.center.latitude,longitude:e.locationBias.center.longitude},radius:a}}}let o=await r(`${i}:searchText`,{method:"POST",headers:{"Content-Type":"application/json","X-Goog-Api-Key":a,"X-Goog-FieldMask":"places.id,places.displayName,places.formattedAddress,places.nationalPhoneNumber,places.internationalPhoneNumber,places.websiteUri,places.googleMapsUri,places.rating,places.userRatingCount,places.types,places.businessStatus,places.primaryType,places.primaryTypeDisplayName,nextPageToken"},body:JSON.stringify(t)},{timeoutMs:15e3,maxRetries:3});if(!o.ok){let e=await o.text();throw Error(`Places API error (${o.status}): ${e}`)}let l=await o.json();if(l.nextPageToken){let e={...t};delete e.pageToken,n.set(l.nextPageToken,{body:e,ts:Date.now()}),n.size>50&&function(){let e=Date.now();for(let[t,a]of n)e-a.ts>6e5&&n.delete(t)}()}return{places:l.places||[],nextPageToken:l.nextPageToken}}async function o(e){let t,{maxPlaces:a,...r}=e,i=Math.max(1,Math.min(a,60)),n=[];for(;n.length<i;){let e=await s({...r,pageSize:Math.min(20,i-n.length),pageToken:t,locationBias:t?void 0:r.locationBias}),a=e.places??[];if(n.push(...a),0===a.length||!e.nextPageToken||n.length>=i)break;t=e.nextPageToken,await new Promise(e=>setTimeout(e,400))}return{places:n.slice(0,i)}}async function l(e){let t=process.env.GOOGLE_PLACES_API_KEY;if(!t)throw Error("GOOGLE_PLACES_API_KEY not configured");let a=await r(`${i}/${e}`,{method:"GET",headers:{"X-Goog-Api-Key":t,"X-Goog-FieldMask":"id,displayName,formattedAddress,nationalPhoneNumber,internationalPhoneNumber,websiteUri,googleMapsUri,rating,userRatingCount,types,businessStatus,currentOpeningHours,reviews,primaryType,primaryTypeDisplayName"}},{timeoutMs:15e3,maxRetries:2});if(!a.ok){let e=await a.text();throw Error(`Place Details error (${a.status}): ${e}`)}return await a.json()}e.s(["PLACES_PAGE_SIZE_MAX",0,20,"getPlaceDetails",()=>l,"textSearch",()=>s,"textSearchAllPages",()=>o],43757)},84143,68162,e=>{"use strict";var t=e.i(78787),a=e.i(43757),r=e.i(10266),i=e.i(44730),n=e.i(98936),s=e.i(75225),o=e.i(84680);class l extends Error{status;body;constructor(e,t){super("string"==typeof t.error?t.error:"Request failed"),this.status=e,this.body=t,this.name="SearchHttpError"}}function c(e,t,a){return e.filter(e=>{let r=e.websiteUri||e.website,i=e.nationalPhoneNumber||e.internationalPhoneNumber||e.phone;return("yes"!==t||!!r)&&("no"!==t||!r)&&("yes"!==a||!!i)&&("no"!==a||!i)})}async function d(e,d){let u,{textQuery:p,includedType:g,pageSize:m,pageToken:h,hasWebsite:A,hasPhone:E,city:f,state:y,country:w,radiusKm:S}=e,I=Math.min(a.PLACES_PAGE_SIZE_MAX,Math.max(1,m??a.PLACES_PAGE_SIZE_MAX)),C={includedType:g??null,hasWebsite:A??null,hasPhone:E??null};s.logger.info("Search request",{textQuery:p,includedType:g??null,effectivePageSize:I,hasWebsite:A??null,hasPhone:E??null});let b=await t.prisma.user.findUnique({where:{id:d},select:{onboardingCompletedAt:!0,workspaces:{include:{workspace:!0},take:1}}});if(!b||0===b.workspaces.length)throw new l(404,{error:"Workspace not found"});if(null==b.onboardingCompletedAt)throw new l(403,{error:"Complete onboarding before searching",code:"REQUIRES_ONBOARDING"});let P=b.workspaces[0].workspace;if(P.leadsUsed>=P.leadsLimit)throw new l(403,{error:"Limit reached",code:"LIMIT_EXCEEDED",limit:P.leadsLimit,used:P.leadsUsed});let N=async(e,a)=>{await t.prisma.searchHistory.create({data:{workspaceId:P.id,userId:d,textQuery:p,pageSize:I,filters:C,resultsCount:e,resultsData:a?JSON.parse(JSON.stringify(a)):void 0}}).catch(e=>s.logger.error("SearchHistory create error",{error:e instanceof Error?e.message:"Unknown"}))};if(!h){let e=`search:${p}:${g||""}:${I}:${A||"any"}:${E||"any"}`,a=await (0,i.getCached)(e),r=a?.places?.length??0,n=Math.min(5,I);if(r>=n)return s.logger.info("Search: cache hit",{cachedCount:r}),await N(r,a.places),{...a,fromCache:!0};r>0&&s.logger.info("Search: cache skipped (below minimum)",{cachedCount:r,minAcceptableFromCache:n});let o=await t.prisma.lead.findMany({where:{OR:[{name:{contains:p,mode:"insensitive"}},{address:{contains:p,mode:"insensitive"}}]},take:100,orderBy:{lastSearchedAt:"desc"}});if(o.length>=10){let e=c(o.map(e=>({id:e.placeId,displayName:{text:e.name},formattedAddress:e.address,nationalPhoneNumber:e.phone,websiteUri:e.website,rating:e.rating,userRatingCount:e.reviewCount,types:e.types,businessStatus:e.businessStatus})),A,E),t=e.slice(0,I);if(t.length>=5)return s.logger.info("Search: local DB used",{dbTotal:o.length,afterFilter:e.length,returned:t.length}),await N(t.length,t),{places:t,fromLocalDb:!0}}s.logger.info("Search: local DB skip",{dbLeadsCount:o.length})}let k=f?.trim();if(k&&!h){let e=await (0,r.geocodeAddress)(k,y??null,w??"Brasil");if(e){let t=S??15,a=Math.min(5e4,Math.round(1e3*t)||Math.round(15e3));u={center:e,radius:a},s.logger.info("Search: locationBias applied",{city:k,radiusKm:t,radiusM:a})}else s.logger.info("Search: geocode failed, no locationBias",{city:k})}h&&await new Promise(e=>setTimeout(e,400)),s.logger.info("Search: calling Google Places API",{textQuery:p,includedType:g??null,hasLocationBias:!!u,hasPageToken:!!h});let R=await (0,a.textSearch)({textQuery:p,includedType:g||void 0,pageSize:I,pageToken:h||void 0,locationBias:u}),L=R.places?.length??0;R.places&&(R.places=c(R.places,A,E).slice(0,I));let _=R.places?.length??0;return s.logger.info("Search: Google Places response",{rawCount:L,afterFilter:_,hasWebsite:A??null,hasPhone:E??null}),R.places&&R.places.length>0&&((0,o.recordUsageEvent)({workspaceId:P.id,userId:d,type:"GOOGLE_PLACES_SEARCH",quantity:1}),(0,n.syncLeads)(R.places).catch(e=>s.logger.error("Background sync error",{error:e instanceof Error?e.message:"Unknown"})),await t.prisma.$transaction([t.prisma.workspace.update({where:{id:P.id},data:{leadsUsed:{increment:1}}}),t.prisma.searchHistory.create({data:{workspaceId:P.id,userId:d,textQuery:p,pageSize:I,filters:C,resultsCount:R.places.length,resultsData:JSON.parse(JSON.stringify(R.places))}})])),s.logger.info("Search: result",{resultCount:_}),R}async function u(e,i,d){let u,{textQuery:p,includedType:g,hasWebsite:m,hasPhone:h,city:A,state:E,country:f,radiusKm:y}=e,w=Math.min(d,60),S=await t.prisma.user.findUnique({where:{id:i},select:{onboardingCompletedAt:!0,workspaces:{include:{workspace:!0},take:1}}});if(!S||0===S.workspaces.length)throw new l(404,{error:"Workspace not found"});if(null==S.onboardingCompletedAt)throw new l(403,{error:"Complete onboarding before searching",code:"REQUIRES_ONBOARDING"});let I=S.workspaces[0].workspace;if(I.leadsUsed>=I.leadsLimit)throw new l(403,{error:"Limit reached",code:"LIMIT_EXCEEDED",limit:I.leadsLimit,used:I.leadsUsed});let C=A?.trim();if(C){let e=await (0,r.geocodeAddress)(C,E??null,f??"Brasil");if(e){let t=Math.min(5e4,Math.round((y??15)*1e3)||Math.round(15e3));u={center:e,radius:t},s.logger.info("SearchAllPages: locationBias applied",{city:C,radiusM:t})}}s.logger.info("SearchAllPages: fetching up to N places",{textQuery:p,effectiveMax:w});let{places:b}=await (0,a.textSearchAllPages)({textQuery:p,includedType:g||void 0,locationBias:u,maxPlaces:w}),P=c(b,m,h).slice(0,w),N=P.length;return P.length>0&&((0,o.recordUsageEvent)({workspaceId:I.id,userId:i,type:"GOOGLE_PLACES_SEARCH",quantity:1}),(0,n.syncLeads)(P).catch(e=>s.logger.error("Background sync error",{error:e instanceof Error?e.message:"Unknown"})),await t.prisma.$transaction([t.prisma.workspace.update({where:{id:I.id},data:{leadsUsed:{increment:1}}}),t.prisma.searchHistory.create({data:{workspaceId:I.id,userId:i,textQuery:p,pageSize:w,filters:{includedType:g??null,hasWebsite:m??null,hasPhone:h??null},resultsCount:N,resultsData:JSON.parse(JSON.stringify(P))}})])),s.logger.info("SearchAllPages: result",{totalFetched:N}),{places:P,totalFetched:N}}e.s(["SEARCH_ALL_PAGES_MAX_PLACES",0,60,"SearchHttpError",()=>l,"runSearch",()=>d,"runSearchAllPages",()=>u],68162),e.s([],84143)}];

//# sourceMappingURL=backend_src_1d089aec._.js.map
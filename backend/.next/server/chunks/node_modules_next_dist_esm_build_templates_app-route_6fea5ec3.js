module.exports=[42845,e=>{"use strict";var t=e.i(47909),a=e.i(74017),i=e.i(96250),s=e.i(59756),o=e.i(61916),r=e.i(74677),n=e.i(69741),d=e.i(16795),l=e.i(87718),u=e.i(95169),c=e.i(47587),p=e.i(66012),g=e.i(70101),m=e.i(26937),x=e.i(10372),v=e.i(93695);e.i(52474);var h=e.i(220),f=e.i(64397),y=e.i(78787),R=e.i(8625),b=e.i(14180),w=e.i(45881);e.i(21564);var T=e.i(71998),C=e.i(87040);e.i(95744);var O=e.i(14578);e.i(69422);var A=e.i(76054),E=e.i(84680),N=e.i(75225);async function k(e,t){var a;let i,s,o,r,n=`${e.businessType} em ${e.city}${e.state?`, ${e.state}`:""}`,d=await y.prisma.user.findFirst({where:{id:t},include:{workspaces:{include:{workspace:!0},take:1}}});d?.workspaces&&d.workspaces.length>0&&(i=d.workspaces[0].workspace.id);let l=[n,`not\xedcias ${e.businessType} ${e.city}`,`tend\xeancias ${e.businessType} ${e.city}`].filter(Boolean),u=await (0,C.getWebContextForRole)("viability",l,i?{workspaceId:i,userId:t}:void 0),[c,p]=await Promise.all([(0,O.runCompetitorAnalysis)({textQuery:n,pageSize:60},t),(0,A.runMarketReport)({textQuery:n,pageSize:60},t)]),g=p.segments.slice(0,10).map(e=>{let t=p.digitalMaturity.total>0?Math.round((p.digitalMaturity.total-p.digitalMaturity.withWebsite)/p.digitalMaturity.total*100):0,a="media";return t>50&&(null==e.avgRating||e.avgRating<4)?a="alta":t<20&&null!=e.avgRating&&e.avgRating>=4.5&&(a="baixa"),{segment:e.type,count:e.count,avgRating:e.avgRating,opportunityLevel:a}}),m={businessType:e.businessType,city:e.city,state:e.state,totalCompetitors:c.totalCount,top3ByRating:c.rankingByRating.slice(0,3).map(e=>`${e.name} (${e.rating}★)`).join(", "),top3ByReviews:c.rankingByReviews.slice(0,3).map(e=>`${e.name} (${e.reviewCount} avalia\xe7\xf5es)`).join(", "),withWebsite:c.digitalPresence.withWebsite,withoutWebsite:c.digitalPresence.withoutWebsite,withPhone:c.digitalPresence.withPhone,withoutPhone:c.digitalPresence.withoutPhone,opportunitiesCount:c.opportunities.length,segments:p.segments.slice(0,10).map(e=>`${e.type}: ${e.count} (avg ${e.avgRating??"n/a"}★)`).join("; "),digitalMaturityPercent:p.digitalMaturity.withWebsitePercent,saturationIndex:p.saturationIndex,avgRating:p.avgRating,topScoredCount:c.topOpportunities.length,avgScore:c.topOpportunities.length>0?Math.round(c.topOpportunities.reduce((e,t)=>e+t.score,0)/c.topOpportunities.length):0},x=(a=e.mode,o=`${e.city}${e.state?`, ${e.state}`:""}`,r=({new_business:`An\xe1lise de viabilidade para **abrir um novo neg\xf3cio** do tipo "${e.businessType}" em ${o}.
Inclua: oportunidade de mercado, satura\xe7\xe3o, melhor modelo de neg\xf3cio, investimento inicial sugerido, locais recomendados.
Para suggestedOffer/suggestedTicket: sugira modelo de neg\xf3cio e faixa de investimento adequados para quem vai abrir esse neg\xf3cio na regi\xe3o.`,expand:`An\xe1lise de viabilidade para **expandir o neg\xf3cio / abrir filial** do tipo "${e.businessType}" em ${o}.
Inclua: atratividade da regi\xe3o para expans\xe3o, concorr\xeancia, riscos e recomenda\xe7\xf5es para abertura de filial.
Para suggestedOffer/suggestedTicket: adapte ao contexto de expans\xe3o/filial (custos, ticket sugerido na nova cidade).`,my_business:`An\xe1lise de viabilidade **do neg\xf3cio do usu\xe1rio** (${e.businessType}) na cidade ${o}.
Use os dados de mercado para avaliar se a cidade \xe9 vi\xe1vel para esse neg\xf3cio espec\xedfico.
Para suggestedOffer/suggestedTicket: recomenda\xe7\xf5es para o neg\xf3cio do usu\xe1rio atuar nessa cidade.`})[a],`Voc\xea \xe9 um consultor de neg\xf3cios especializado em an\xe1lise de viabilidade local no Brasil.
${r}

DADOS DO MERCADO LOCAL:
- Total de concorrentes mapeados: ${m.totalCompetitors}
- Rating m\xe9dio: ${m.avgRating??"N/A"}
- Top 3 por avalia\xe7\xe3o: ${m.top3ByRating||"N/A"}
- Top 3 por volume de reviews: ${m.top3ByReviews||"N/A"}
- Com website: ${m.withWebsite} / Sem website: ${m.withoutWebsite}
- Com telefone: ${m.withPhone} / Sem telefone: ${m.withoutPhone}
- Oportunidades (sem presen\xe7a digital): ${m.opportunitiesCount}
- Top leads com score de oportunidade: ${m.topScoredCount} (score m\xe9dio: ${m.avgScore}/100)
- Segmentos encontrados: ${m.segments||"N/A"}
- Maturidade digital da regi\xe3o: ${m.digitalMaturityPercent}%
- \xcdndice de satura\xe7\xe3o: ${m.saturationIndex}

Responda EXCLUSIVAMENTE em JSON v\xe1lido, sem markdown, sem backticks:
{
  "score": <n\xfamero 0-10, onde 10 = altamente vi\xe1vel>,
  "verdict": "<uma frase curta: Altamente Vi\xe1vel / Vi\xe1vel com Ressalvas / Moderado / Arriscado / N\xe3o Recomendado>",
  "goNoGo": "<GO | CAUTION | NO_GO>",
  "summary": "<par\xe1grafo de 3-4 frases explicando a viabilidade geral com dados concretos>",
  "strengths": ["<ponto forte 1>", "<ponto forte 2>", "<ponto forte 3>"],
  "risks": ["<risco 1>", "<risco 2>", "<risco 3>"],
  "recommendations": ["<recomenda\xe7\xe3o 1>", "<recomenda\xe7\xe3o 2>", "<recomenda\xe7\xe3o 3>", "<recomenda\xe7\xe3o 4>"],
  "estimatedInvestment": "<faixa estimada de investimento inicial para esse tipo de neg\xf3cio nessa regi\xe3o>",
  "bestLocations": ["<sugest\xe3o de bairro/regi\xe3o 1>", "<sugest\xe3o 2>"],
  "dailyLeadsTarget": <n\xfamero inteiro: quantos leads por dia prospectar nesse nicho>,
  "suggestedOffer": "<oferta sugerida conforme o contexto do modo de an\xe1lise>",
  "suggestedTicket": "<ticket mensal sugerido conforme o contexto>"
}

REGRAS CR\xcdTICAS:
- Baseie-se APENAS nos dados fornecidos acima
- score deve refletir a realidade: se h\xe1 muitos concorrentes com alta avalia\xe7\xe3o, o score deve ser menor
- goNoGo: GO se score >= 7, CAUTION se 4-6, NO_GO se < 4
- dailyLeadsTarget: base no total de oportunidades e um ritmo realista
- suggestedTicket: baseado no nicho e na regi\xe3o
- Seja realista e honesto, n\xe3o superestime a viabilidade
${u?`

${u}

`:""}`),{config:v}=await (0,T.resolveAiForRole)("viability"),h=await (0,T.generateCompletionForRole)("viability",{prompt:x,jsonMode:!0,maxTokens:4096});i&&h.usage&&(0,E.recordUsageEvent)({workspaceId:i,userId:t,type:"AI_TOKENS",quantity:1,metadata:{provider:v.provider,model:v.model,inputTokens:h.usage.inputTokens,outputTokens:h.usage.outputTokens}});let f=h.text;try{let e=f.replace(/```json\s*/gi,"").replace(/```\s*/gi,"").trim();s=JSON.parse(e)}catch{s={score:5,verdict:"Análise parcial",goNoGo:"CAUTION",summary:"Não foi possível gerar análise completa. Tente novamente.",strengths:["Dados de mercado coletados com sucesso"],risks:["Análise de IA incompleta"],recommendations:["Tente novamente com termos mais específicos"],estimatedInvestment:"Não estimado",bestLocations:[e.city],dailyLeadsTarget:5,suggestedOffer:"Pacote Website + SEO Local",suggestedTicket:"Consultar valores"}}let R=["GO","CAUTION","NO_GO"].includes(s.goNoGo)?s.goNoGo:"CAUTION",b={score:Math.min(10,Math.max(0,s.score)),verdict:s.verdict,goNoGo:R,summary:s.summary,competitorDensity:c.totalCount,saturationIndex:p.saturationIndex,digitalMaturityPercent:p.digitalMaturity.withWebsitePercent,strengths:s.strengths||[],risks:s.risks||[],recommendations:s.recommendations||[],estimatedInvestment:s.estimatedInvestment||"Não estimado",bestLocations:s.bestLocations||[],segmentBreakdown:g,dailyLeadsTarget:s.dailyLeadsTarget||5,suggestedOffer:s.suggestedOffer||"Pacote Website + SEO Local",suggestedTicket:s.suggestedTicket||"Consultar valores",topOpportunities:c.topOpportunities.slice(0,20)};return i&&y.prisma.intelligenceReport.create({data:{workspaceId:i,userId:t,module:"VIABILITY",inputQuery:`${e.businessType} em ${e.city}`,inputCity:e.city,inputState:e.state,resultsData:JSON.parse(JSON.stringify(b))}}).catch(e=>N.logger.error("Failed to persist viability report",{error:e instanceof Error?e.message:"Unknown"})),b}var $=e.i(69719);let I=$.z.enum(["new_business","expand","my_business"]),P=$.z.object({mode:I,businessType:$.z.string().min(2).max(200).optional(),city:$.z.string().min(2).max(200),state:$.z.string().max(100).optional()}).refine(e=>"my_business"===e.mode||"string"==typeof e.businessType&&e.businessType.length>=2,{message:"businessType is required when mode is new_business or expand",path:["businessType"]});async function S(t){let a=(0,b.getOrCreateRequestId)(t);try{let e,i=t.headers.get("x-forwarded-for")||"127.0.0.1",{success:s}=await (0,R.rateLimit)(`viability:${i}`,10,60);if(!s)return(0,b.jsonWithRequestId)({error:"Too many requests. Try again later."},{status:429,requestId:a});let o=await t.json(),r=P.safeParse(o);if(!r.success)return(0,b.jsonWithRequestId)({error:r.error.issues.map(e=>e.message).join(", ")},{status:400,requestId:a});let n=await (0,f.auth)();if(!n?.user?.id)return(0,b.jsonWithRequestId)({error:"Unauthorized"},{status:401,requestId:a});let d=await y.prisma.user.findUnique({where:{id:n.user.id},select:{workspaces:{include:{workspace:{select:{plan:!0}}},take:1},plan:!0,companyName:!0,productService:!0}}),l=d?.workspaces?.[0]?.workspace?.plan??d?.plan??"FREE";if(!(0,w.planHasModule)(l,"INTELIGENCIA_MERCADO"))return(0,b.jsonWithRequestId)({error:"Viability analysis is only available on Scale plan. Upgrade to access."},{status:403,requestId:a});let u=r.data.mode;if("my_business"===u){let t=[d?.companyName,d?.productService].filter(e=>!!e?.trim());if(!(e=t.length>0?t.join(" — "):"").trim())return(0,b.jsonWithRequestId)({error:"Complete seu perfil (empresa/serviço) para usar esta análise. Acesse Configurações ou Perfil."},{status:400,requestId:a})}else e=r.data.businessType;let c={mode:u,businessType:e,city:r.data.city,state:r.data.state},p=await k(c,n.user.id);return(0,b.jsonWithRequestId)(p,{requestId:a})}catch(i){let{logger:t}=await e.A(31443);return t.error("Viability error",{error:i instanceof Error?i.message:"Unknown"},a),(0,b.jsonWithRequestId)({error:"Internal server error"},{status:500,requestId:a})}}e.s(["POST",()=>S],49442);var M=e.i(49442);let _=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/viability/route",pathname:"/api/viability",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/backend/src/app/api/viability/route.ts",nextConfigOutput:"standalone",userland:M}),{workAsyncStorage:q,workUnitAsyncStorage:U,serverHooks:j}=_;function L(){return(0,i.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:U})}async function D(e,t,i){_.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/viability/route";f=f.replace(/\/index$/,"")||"/";let y=await _.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:R,params:b,nextConfig:w,parsedUrl:T,isDraftMode:C,prerenderManifest:O,routerServerContext:A,isOnDemandRevalidate:E,revalidateOnlyGenerated:N,resolvedPathname:k,clientReferenceManifest:$,serverActionsManifest:I}=y,P=(0,n.normalizeAppPath)(f),S=!!(O.dynamicRoutes[P]||O.routes[k]),M=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,T,!1):t.end("This page could not be found"),null);if(S&&!C){let e=!!O.routes[k],t=O.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await M();throw new v.NoFallbackError}}let q=null;!S||_.isDev||C||(q="/index"===(q=k)?"/":q);let U=!0===_.isDev||!S,j=S&&!U;I&&$&&(0,r.setManifestsSingleton)({page:f,clientReferenceManifest:$,serverActionsManifest:I});let L=e.method||"GET",D=(0,o.getTracer)(),W=D.getActiveScopeSpan(),H={params:b,prerenderManifest:O,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,i,s)=>_.onRequestError(e,t,i,s,A)},sharedContext:{buildId:R}},G=new d.NodeNextRequest(e),B=new d.NodeNextResponse(t),F=l.NextRequestAdapter.fromNodeNextRequest(G,(0,l.signalFromNodeResponse)(t));try{let r=async e=>_.handle(F,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=D.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=a.get("next.route");if(i){let t=`${L} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${f}`)}),n=!!(0,s.getRequestMeta)(e,"minimalMode"),d=async s=>{var o,d;let l=async({previousCacheEntry:a})=>{try{if(!n&&E&&N&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await r(s);e.fetchMetrics=H.renderOpts.fetchMetrics;let d=H.renderOpts.pendingWaitUntil;d&&i.waitUntil&&(i.waitUntil(d),d=void 0);let l=H.renderOpts.collectedTags;if(!S)return await (0,p.sendResponse)(G,B,o,H.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(o.headers);l&&(t[x.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=x.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,i=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=x.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:i}}}}catch(t){throw(null==a?void 0:a.isStale)&&await _.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:E})},!1,A),t}},u=await _.handleResponse({req:e,nextConfig:w,cacheKey:q,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:O,isRoutePPREnabled:!1,isOnDemandRevalidate:E,revalidateOnlyGenerated:N,responseGenerator:l,waitUntil:i.waitUntil,isMinimalMode:n});if(!S)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});n||t.setHeader("x-nextjs-cache",E?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let v=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return n&&S||v.delete(x.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||v.get("Cache-Control")||v.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(G,B,new Response(u.value.body,{headers:v,status:u.value.status||200})),null};W?await d(W):await D.withPropagatedContext(e.headers,()=>D.trace(u.BaseServerSpan.handleRequest,{spanName:`${L} ${f}`,kind:o.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},d))}catch(t){if(t instanceof v.NoFallbackError||await _.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:E})},!1,A),S)throw t;return await (0,p.sendResponse)(G,B,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>L,"routeModule",()=>_,"serverHooks",()=>j,"workAsyncStorage",()=>q,"workUnitAsyncStorage",()=>U],42845)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_6fea5ec3.js.map
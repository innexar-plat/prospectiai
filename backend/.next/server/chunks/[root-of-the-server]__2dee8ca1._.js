module.exports=[54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},63021,(e,t,r)=>{t.exports=e.x("@prisma/client-2c3a283f134fdcb6",()=>require("@prisma/client-2c3a283f134fdcb6"))},78787,e=>{"use strict";var t=e.i(63021);let r=e.g.prisma||new t.PrismaClient({log:["error"]});e.s(["prisma",0,r])},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},20635,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/action-async-storage.external.js",()=>require("next/dist/server/app-render/action-async-storage.external.js"))},48419,e=>{"use strict";var t=e.i(69719);let r=t.z.object({email:t.z.string().email("Invalid email").transform(e=>e.trim().toLowerCase()),password:t.z.string().min(8,"Password must be at least 8 characters"),name:t.z.string().max(200).optional().transform(e=>e?.trim()||void 0)}),a=t.z.object({companyName:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),productService:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),targetAudience:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),mainBenefit:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0)}),i=t.z.object({textQuery:t.z.string().min(1,"textQuery is required").max(500),includedType:t.z.string().max(100).optional(),pageSize:t.z.coerce.number().int().min(1).max(100).optional(),pageToken:t.z.string().optional(),hasWebsite:t.z.enum(["yes","no"]).optional(),hasPhone:t.z.enum(["yes","no"]).optional(),city:t.z.string().max(200).optional(),state:t.z.string().max(100).optional(),country:t.z.string().max(100).optional(),radiusKm:t.z.coerce.number().min(1).max(100).optional()}),n=t.z.object({textQuery:t.z.string().min(1,"textQuery is required").max(500),includedType:t.z.string().max(100).optional(),pageSize:t.z.coerce.number().int().min(1).max(60).optional(),city:t.z.string().max(200).optional(),state:t.z.string().max(100).optional()}),o=t.z.object({placeId:t.z.string().min(1,"placeId is required"),name:t.z.string().min(1,"Business name is required"),userProfile:t.z.record(t.z.string(),t.z.unknown()).optional(),locale:t.z.string().optional(),websiteUri:t.z.string().optional(),website:t.z.string().optional(),formattedAddress:t.z.string().optional(),address:t.z.string().optional(),nationalPhoneNumber:t.z.string().optional(),internationalPhoneNumber:t.z.string().optional(),phone:t.z.string().optional(),rating:t.z.number().optional(),userRatingCount:t.z.number().optional(),reviewCount:t.z.number().optional(),types:t.z.array(t.z.string()).optional(),primaryType:t.z.string().optional(),businessStatus:t.z.string().optional(),reviews:t.z.array(t.z.object({rating:t.z.number(),text:t.z.object({text:t.z.string()}).optional(),authorAttribution:t.z.object({displayName:t.z.string()}).optional(),relativePublishTimeDescription:t.z.string().optional()})).optional()}),s=t.z.object({name:t.z.string().max(200).optional().transform(e=>e?.trim()||void 0),phone:t.z.string().max(50).optional().transform(e=>e?.trim()||void 0),address:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),linkedInUrl:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),instagramUrl:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),facebookUrl:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),websiteUrl:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),image:t.z.string().max(2e3).optional().transform(e=>e?.trim()||void 0),notifyByEmail:t.z.boolean().optional(),notifyWeeklyReport:t.z.boolean().optional(),notifyLeadAlerts:t.z.boolean().optional()}),l=t.z.object({useProfile:t.z.boolean().optional().default(!0),companyName:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),city:t.z.string().max(200).optional().transform(e=>e?.trim()||void 0),state:t.z.string().max(100).optional().transform(e=>e?.trim()||void 0),productService:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),targetAudience:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),mainBenefit:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),address:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),websiteUrl:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),linkedInUrl:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),instagramUrl:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),facebookUrl:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0)}),p=t.z.object({companyName:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),productService:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),targetAudience:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),mainBenefit:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),address:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),linkedInUrl:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),instagramUrl:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),facebookUrl:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),websiteUrl:t.z.string().max(500).optional().transform(e=>e?.trim()||void 0),logoUrl:t.z.string().max(2e3).optional().transform(e=>e?.trim()||void 0)}),c=t.z.object({planId:t.z.string().min(1,"planId is required"),locale:t.z.string().max(10).optional(),cycle:t.z.enum(["monthly","annual"]).optional(),interval:t.z.enum(["monthly","annual"]).optional(),card_token_id:t.z.string().max(500).optional(),scheduleAtPeriodEnd:t.z.boolean().optional()}),d=t.z.object({planId:t.z.enum(["FREE","BASIC","PRO","BUSINESS","SCALE"],{message:"planId must be a valid plan key"})}),u=t.z.object({token:t.z.string().min(1,"token is required"),issuer_id:t.z.string().optional(),payment_method_id:t.z.string().min(1,"payment_method_id is required"),transaction_amount:t.z.coerce.number().positive("transaction_amount must be positive"),installments:t.z.number().int().min(1).optional(),payer:t.z.object({email:t.z.string().email().optional(),identification:t.z.object({type:t.z.string().optional(),number:t.z.string().optional()}).optional()}).optional(),planId:t.z.string().min(1,"planId is required"),interval:t.z.enum(["monthly","annual"])}),m=t.z.object({limit:t.z.coerce.number().int().min(1).max(100).optional(),offset:t.z.coerce.number().int().min(0).optional(),workspaceId:t.z.string().min(1).optional()}),g=t.z.object({limit:t.z.coerce.number().int().min(1).max(100).optional(),offset:t.z.coerce.number().int().min(0).optional(),search:t.z.string().min(1).max(200).optional()}),h=t.z.object({reason:t.z.string().max(500).optional()}),f=t.z.object({sendEmail:t.z.boolean().optional(),temporaryPassword:t.z.string().min(8,"Password must be at least 8 characters").optional()}).refine(e=>!0===e.sendEmail||null!=e.temporaryPassword&&e.temporaryPassword.length>=8,{message:"Either sendEmail true or temporaryPassword (min 8 chars) is required"}),x=t.z.object({plan:t.z.enum(["FREE","BASIC","PRO","BUSINESS","SCALE"]).optional(),leadsLimit:t.z.coerce.number().int().min(0).optional()}),b=t.z.object({email:t.z.string().email("Valid email is required").transform(e=>e.trim().toLowerCase())}),z=t.z.object({email:t.z.string().min(1,"Email is required").email("Invalid email address")}),v=t.z.object({token:t.z.string().min(1,"Token and password are required"),password:t.z.string().min(8,"Password must be at least 8 characters")}),y=t.z.object({code:t.z.string().length(6,"Code must be 6 digits").regex(/^\d{6}$/,"Code must be 6 digits")}),w=t.z.object({placeId:t.z.string().min(1,"placeId is required")}),_=t.z.object({format:t.z.enum(["json","csv"]).optional()}),E=t.z.object({limit:t.z.coerce.number().int().min(1).max(100).optional(),offset:t.z.coerce.number().int().min(0).optional()}),S=t.z.object({status:t.z.enum(["NEW","CONTACTED","CONVERTED","LOST"]).optional(),isFavorite:t.z.boolean().optional()}).refine(e=>void 0!==e.status||void 0!==e.isFavorite,{message:"At least one of status or isFavorite is required"}),R=t.z.object({userIdToRemove:t.z.string().min(1,"User ID to remove is required")}),P=o.extend({userId:t.z.string().optional()}),A=t.z.object({role:t.z.enum(["lead_analysis","viability"]),provider:t.z.enum(["GEMINI","OPENAI","CLOUDFLARE"]),model:t.z.string().min(1).max(200),apiKey:t.z.string().optional(),cloudflareAccountId:t.z.string().max(100).optional(),enabled:t.z.boolean().optional().default(!0)}),C=t.z.object({role:t.z.enum(["lead_analysis","viability"]).optional(),provider:t.z.enum(["GEMINI","OPENAI","CLOUDFLARE"]).optional(),model:t.z.string().min(1).max(200).optional(),apiKey:t.z.string().optional(),cloudflareAccountId:t.z.string().max(100).optional().nullable(),enabled:t.z.boolean().optional()}),I=t.z.object({role:t.z.enum(["lead_analysis","viability"]),provider:t.z.enum(["SERPER","TAVILY"]),apiKey:t.z.string().optional(),maxResults:t.z.number().int().min(1).max(20).optional().default(5),enabled:t.z.boolean().optional().default(!0)});function k(e){let t=e.error.issues[0];return t?`${t.path.join(".")||"body"}: ${t.message}`:"Validation failed"}e.s(["adminListQuerySchema",0,m,"adminResetPasswordSchema",0,f,"adminWorkspaceUpdateSchema",0,x,"aiConfigCreateSchema",0,A,"aiConfigUpdateSchema",0,C,"analyzeSchema",0,o,"checkoutSchema",0,c,"companyAnalysisSchema",0,l,"detailsQuerySchema",0,w,"exportLeadsQuerySchema",0,_,"forgotSchema",0,z,"formatZodError",()=>k,"leadStatusSchema",0,S,"marketReportSchema",0,n,"onboardingCompleteSchema",0,a,"processPaymentSchema",0,u,"profileSchema",0,s,"registerSchema",0,r,"resetSchema",0,v,"scheduleDowngradeSchema",0,d,"searchHistoryQuerySchema",0,E,"searchSchema",0,i,"supportDeactivateSchema",0,h,"supportUsersListSchema",0,g,"teamInviteSchema",0,b,"teamRemoveSchema",0,R,"twoFaCodeSchema",0,y,"v1AnalyzeSchema",0,P,"webSearchConfigSchema",0,I,"workspaceProfileSchema",0,p])},75225,e=>{"use strict";let t={info:0,warn:1,error:2},r="error"===process.env.LOG_LEVEL?"error":"info";function a(e,a,i,n){if(!(t[e]>=t[r]))return;let o=JSON.stringify({level:e,message:a,timestamp:new Date().toISOString(),...n&&{requestId:n},...i});"error"===e?process.stderr.write(o+"\n"):process.stdout.write(o+"\n")}function i(e){let t=e.headers.get("x-request-id");if(t&&"string"==typeof t)return t}e.s(["getRequestId",()=>i,"logger",0,{info(e,t,r){a("info",e,t,r)},warn(e,t,r){a("warn",e,t,r)},error(e,t,r){a("error",e,t,r)}}])},22734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},46786,(e,t,r)=>{t.exports=e.x("os",()=>require("os"))},79594,(e,t,r)=>{t.exports=e.x("dns",()=>require("dns"))},4446,(e,t,r)=>{t.exports=e.x("net",()=>require("net"))},55004,(e,t,r)=>{t.exports=e.x("tls",()=>require("tls"))},14747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},88947,(e,t,r)=>{t.exports=e.x("stream",()=>require("stream"))},27699,(e,t,r)=>{t.exports=e.x("events",()=>require("events"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},92509,(e,t,r)=>{t.exports=e.x("url",()=>require("url"))},8625,e=>{"use strict";var t=e.i(42512),r=e.i(75225);let a=null;async function i(e,i,n){try{let o=function(){if(a)return a;let e=process.env.REDIS_URL||"redis://localhost:6379";try{return(a=new t.default(e,{maxRetriesPerRequest:1,retryStrategy:e=>e>2?null:Math.min(200*e,1e3),lazyConnect:!0})).on("error",()=>{a=null}),a}catch{return null}}();if(!o)return r.logger.warn("Redis down, bypassing rate limit",{identifier:e}),{success:!0,remaining:i,reset:0};await o.connect().catch(()=>{});let s=`ratelimit:${e}`,l=await o.get(s),p=l?parseInt(l):0;if(p>=i){let e=await o.ttl(s);return{success:!1,remaining:0,reset:Date.now()+(e>0?1e3*e:1e3*n)}}let c=o.multi();return c.incr(s),l||c.expire(s,n),await c.exec(),{success:!0,remaining:i-(p+1),reset:Date.now()+1e3*n}}catch(e){return r.logger.error("Rate limit error",{error:e instanceof Error?e.message:"Unknown"}),{success:!0,remaining:i,reset:0}}}e.s(["rateLimit",()=>i])},21517,(e,t,r)=>{t.exports=e.x("http",()=>require("http"))},24836,(e,t,r)=>{t.exports=e.x("https",()=>require("https"))},33405,(e,t,r)=>{t.exports=e.x("child_process",()=>require("child_process"))},6461,(e,t,r)=>{t.exports=e.x("zlib",()=>require("zlib"))},34273,e=>{"use strict";let t=["FREE","BASIC","PRO","BUSINESS","SCALE"];function r(e,r){let a=t.indexOf(e),i=t.indexOf(r);return!(a<0)&&!(i<0)&&i<a}function a(e,r){let a=t.indexOf(e),i=t.indexOf(r);return!(a<0)&&!(i<0)&&i>a}function i(e,t){return e[t]}e.s(["PLANS",0,{FREE:{name:"Free",leadsLimit:5,monthly:{price_usd:0,price_brl:0},annual:{price_usd:0,price_brl:0}},BASIC:{name:"Starter",leadsLimit:100,monthly:{price_usd:25,price_brl:129},annual:{price_usd:255,price_brl:1315}},PRO:{name:"Growth",leadsLimit:400,monthly:{price_usd:79,price_brl:397},annual:{price_usd:805,price_brl:4049}},BUSINESS:{name:"Business",leadsLimit:1200,monthly:{price_usd:199,price_brl:997},annual:{price_usd:2029,price_brl:10169}},SCALE:{name:"Enterprise",leadsLimit:5e3,monthly:{price_usd:499,price_brl:2497},annual:{price_usd:5089,price_brl:25469}}},"getPlanPrices",()=>i,"isDowngrade",()=>r,"isUpgrade",()=>a])},60843,e=>{"use strict";let t="https://api.mercadopago.com";async function r(e){let r=process.env.MERCADOPAGO_ACCESS_TOKEN;if(!r)throw Error("MERCADOPAGO_ACCESS_TOKEN is not set");let a="annual"===e.cycle?12:1,i=new Date,n=new Date(i);n.setFullYear(n.getFullYear()+2);let o={reason:e.reason,external_reference:e.externalReference,payer_email:e.payerEmail,card_token_id:e.cardTokenId,auto_recurring:{frequency:a,frequency_type:"months",start_date:i.toISOString(),end_date:n.toISOString(),transaction_amount:e.transactionAmount,currency_id:"BRL"},back_url:e.backUrl,status:"authorized",...e.notificationUrl&&{notification_url:e.notificationUrl}},s=await fetch(`${t}/preapproval`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(o)});if(!s.ok){let e=await s.text();throw Error(`Mercado Pago preapproval failed: ${s.status} ${e}`)}return s.json()}async function a(e){let r=process.env.MERCADOPAGO_ACCESS_TOKEN;if(!r)throw Error("MERCADOPAGO_ACCESS_TOKEN is not set");let a=await fetch(`${t}/preapproval/${e}`,{headers:{Authorization:`Bearer ${r}`}});if(!a.ok){let e=await a.text();throw Error(`Mercado Pago get preapproval failed: ${a.status} ${e}`)}return a.json()}async function i(e){let r=process.env.MERCADOPAGO_ACCESS_TOKEN;if(!r)throw Error("MERCADOPAGO_ACCESS_TOKEN is not set");let a=await fetch(`${t}/preapproval/${e}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({status:"cancelled"})});if(!a.ok){let e=await a.text();throw Error(`Mercado Pago cancel preapproval failed: ${a.status} ${e}`)}}e.s(["cancelPreApproval",()=>i,"createPreApproval",()=>r,"getPreApproval",()=>a])},91787,e=>{"use strict";var t=e.i(87530),r=e.i(78787),a=e.i(34273),i=e.i(75225);let n="monthly";async function o(e,o){var s;let l=e.plan,p=a.PLANS[o];if(!p||"FREE"===o)throw{status:400,error:"Invalid plan or use cancel flow for Free."};if(!(0,a.isDowngrade)(l,o))throw{status:400,error:"Schedule downgrade only applies when moving to a lower tier."};if("FREE"===l)throw{status:400,error:"Current plan is Free. Use checkout to subscribe."};let c=e.subscriptionId,d=new Date,u=e.currentPeriodEnd,m=new Date(null!=u&&u>d?u:d.getTime()+2592e6);if(null!=c&&null!=(s=c)&&s.startsWith("sub_"))try{let e=await t.stripe.subscriptions.retrieve(c,{expand:["items.data.price"]}),r=e.current_period_end,i=e.items.data[0];if(!i?.price)throw{status:400,error:"Subscription has no price item"};let s=await t.stripe.subscriptionSchedules.create({from_subscription:c}),d=Math.round(100*(0,a.getPlanPrices)(p,n).price_usd),u=[{price_data:{currency:"usd",product_data:{name:`ProspectorAI ${p.name} Plan (monthly)`,description:`Subscription for ${p.leadsLimit} leads searches per month.`},unit_amount:d,recurring:{interval:"month"}},quantity:1}];await t.stripe.subscriptionSchedules.update(s.id,{end_behavior:"release",phases:[{start_date:e.current_period_start,end_date:r,items:[{price:i.price.id,quantity:1}],metadata:{planId:l}},{start_date:r,items:u,metadata:{planId:o}}]})}catch(t){if("object"==typeof t&&null!=t&&"status"in t&&"error"in t)throw t;let e=t instanceof Error?t.message:"Stripe API error";throw i.logger.error("Stripe schedule downgrade failed",{subscriptionId:c,error:e}),{status:502,error:"Could not schedule plan change with payment provider. Try again later."}}await r.prisma.workspace.update({where:{id:e.id},data:{pendingPlanId:o,pendingPlanEffectiveAt:m,...null==u||u<=d?{currentPeriodEnd:m}:{}}});let g=p.name,h=(0,a.getPlanPrices)(p,n).price_brl;return{message:`Seu plano ser\xe1 alterado para ${g} em ${m.toLocaleDateString("pt-BR")}. A pr\xf3xima cobran\xe7a ser\xe1 no valor de R$ ${h.toLocaleString("pt-BR")} no dia ${m.toLocaleDateString("pt-BR")}.`,pendingPlanId:o,pendingPlanEffectiveAt:m.toISOString()}}e.s(["performScheduleDowngrade",()=>o])},87100,e=>{"use strict";var t=e.i(47909),r=e.i(74017),a=e.i(96250),i=e.i(59756),n=e.i(61916),o=e.i(74677),s=e.i(69741),l=e.i(16795),p=e.i(87718),c=e.i(95169),d=e.i(47587),u=e.i(66012),m=e.i(70101),g=e.i(26937),h=e.i(10372),f=e.i(93695);e.i(52474);var x=e.i(220),b=e.i(89171),z=e.i(64397),v=e.i(87530),y=e.i(58814),w=e.i(60843),_=e.i(8625),E=e.i(34273),S=e.i(75225),R=e.i(48419),P=e.i(78787),A=e.i(91787);async function C(e){let t=await (0,z.auth)();if(!t?.user?.id||!t?.user?.email)return b.NextResponse.json({error:"Unauthorized"},{status:401});let{success:r}=await (0,_.rateLimit)(`checkout:${t.user.id}`,10,60);if(!r)return b.NextResponse.json({error:"Too many requests. Try again later."},{status:429});try{let r=await e.json(),a=R.checkoutSchema.safeParse(r);if(!a.success)return b.NextResponse.json({error:(0,R.formatZodError)(a)},{status:400});let{planId:i,interval:n,cycle:o,locale:s,card_token_id:l,scheduleAtPeriodEnd:p}=a.data,c=(n??o)==="annual"?"annual":"monthly",d=E.PLANS[i];if(!d||"FREE"===i)return b.NextResponse.json({error:"Invalid plan"},{status:400});let u=await P.prisma.user.findUnique({where:{id:t.user.id},include:{workspaces:{take:1,include:{workspace:!0}}}}),m=u?.workspaces?.[0]?.workspace,g=m?.plan,h=!0===p&&null!=g&&null!=m&&(0,E.isDowngrade)(g,i);if(!0===p&&!h){let e=[];null==g&&e.push("no_current_plan"),m||e.push("no_workspace"),null==g||(0,E.isDowngrade)(g,i)||e.push("not_downgrade_tier"),S.logger.info("Checkout: scheduleAtPeriodEnd true but not treating as downgrade",{userId:t.user.id,planId:i,currentPlan:g??null,hasWorkspace:!!m,reasons:e})}if(h&&m)try{let e=await (0,A.performScheduleDowngrade)({id:m.id,plan:m.plan,subscriptionId:m.subscriptionId,currentPeriodEnd:m.currentPeriodEnd},i);return b.NextResponse.json({url:null,scheduled:!0,message:e.message,pendingPlanEffectiveAt:e.pendingPlanEffectiveAt})}catch(e){if("number"==typeof e.status&&"string"==typeof e.error)return b.NextResponse.json({error:e.error},{status:e.status});throw e}let f=process.env.NEXT_PUBLIC_APP_URL||"",x=s||"pt",z=m?.subscriptionId!=null&&m.subscriptionId.startsWith("sub_"),_=null!=g&&"FREE"!==g&&null!=m&&(0,E.isUpgrade)(g,i);if("pt"!==x&&_&&z&&m)try{let e=(await v.stripe.subscriptions.retrieve(m.subscriptionId,{expand:["items.data.price","items.data.price.product"]})).items.data[0],r=e?.price,a=r?.recurring?.interval??"month",n="string"==typeof r?.product?r.product:void 0,o="monthly"===c&&"month"===a||"annual"===c&&"year"===a;if(e&&o&&n){let r=m.subscriptionId,o=Math.round(100*(0,E.getPlanPrices)(d,c).price_usd);await v.stripe.subscriptions.update(r,{items:[{id:e.id,price_data:{currency:"usd",unit_amount:o,recurring:{interval:a},product:n}}],proration_behavior:"always_invoice",metadata:{planId:i,userId:t.user.id,interval:c}}),S.logger.info("Stripe subscription upgraded with proration",{userId:t.user.id,workspaceId:m.id,from:g,to:i,cycle:c});let s=`${f}/${x}/billing/success?upgraded=1`;return b.NextResponse.json({url:s})}}catch(e){return S.logger.error("Stripe upgrade failed",{userId:t.user.id,error:e instanceof Error?e.message:"Unknown"}),b.NextResponse.json({error:"Failed to upgrade subscription. Try again or use checkout."},{status:502})}let{price_brl:C,price_usd:I}=(0,E.getPlanPrices)(d,c);if("pt"===x){if(l){let e=await (0,w.createPreApproval)({payerEmail:t.user.email,cardTokenId:l,reason:`ProspectorAI Plano ${d.name} (${c})`,externalReference:`${t.user.id}:${i}:${c}`,transactionAmount:C,cycle:c,backUrl:`${f}/${x}/billing/success`,notificationUrl:`${f}/api/billing/webhook/mercadopago`});S.logger.info("MP PreApproval Created",{preApprovalId:e.id,status:e.status});let r=e.init_point||`${f}/${x}/billing/success`;return b.NextResponse.json({url:r})}let e=await y.preference.create({body:{items:[{id:`${i}_${c}`,title:`ProspectorAI Plano ${d.name} (${c})`,description:`Assinatura ${c} para ${d.leadsLimit} buscas por m\xeas.`,quantity:1,unit_price:C,currency_id:"BRL"}],back_urls:{success:`${f}/${x}/dashboard`,failure:`${f}/${x}/dashboard`,pending:`${f}/${x}/dashboard`},auto_return:"approved",notification_url:`${f}/api/billing/webhook/mercadopago`,metadata:{user_id:t.user.id,plan_id:i,interval:c},payer:{email:t.user.email,name:t.user.name||"Cliente ProspectorAI"}}});return S.logger.info("MP Preference Created",{preferenceId:e.id,initPoint:e.init_point}),b.NextResponse.json({url:e.init_point})}{let e=await v.stripe.checkout.sessions.create({customer_email:t.user.email,line_items:[{price_data:{currency:"usd",product_data:{name:`ProspectorAI ${d.name} Plan (${c})`,description:`Subscription for ${d.leadsLimit} leads searches per month.`},unit_amount:100*I,recurring:{interval:"annual"===c?"year":"month"}},quantity:1}],mode:"subscription",success_url:`${process.env.NEXT_PUBLIC_APP_URL}/${s}/billing/success?session_id={CHECKOUT_SESSION_ID}`,cancel_url:`${process.env.NEXT_PUBLIC_APP_URL}/${s}/pricing`,metadata:{userId:t.user.id,planId:i,interval:c}});return b.NextResponse.json({url:e.url})}}catch(e){return S.logger.error("Checkout failed",{error:e instanceof Error?e.message:"Unknown"}),b.NextResponse.json({error:"Failed to create checkout session"},{status:500})}}e.s(["POST",()=>C],35225);var I=e.i(35225);let k=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/billing/checkout/route",pathname:"/api/billing/checkout",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/backend/src/app/api/billing/checkout/route.ts",nextConfigOutput:"standalone",userland:I}),{workAsyncStorage:j,workUnitAsyncStorage:N,serverHooks:$}=k;function O(){return(0,a.patchFetch)({workAsyncStorage:j,workUnitAsyncStorage:N})}async function q(e,t,a){k.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let b="/api/billing/checkout/route";b=b.replace(/\/index$/,"")||"/";let z=await k.prepare(e,t,{srcPage:b,multiZoneDraftMode:!1});if(!z)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:v,params:y,nextConfig:w,parsedUrl:_,isDraftMode:E,prerenderManifest:S,routerServerContext:R,isOnDemandRevalidate:P,revalidateOnlyGenerated:A,resolvedPathname:C,clientReferenceManifest:I,serverActionsManifest:j}=z,N=(0,s.normalizeAppPath)(b),$=!!(S.dynamicRoutes[N]||S.routes[C]),O=async()=>((null==R?void 0:R.render404)?await R.render404(e,t,_,!1):t.end("This page could not be found"),null);if($&&!E){let e=!!S.routes[C],t=S.dynamicRoutes[N];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await O();throw new f.NoFallbackError}}let q=null;!$||k.isDev||E||(q="/index"===(q=C)?"/":q);let U=!0===k.isDev||!$,T=$&&!U;j&&I&&(0,o.setManifestsSingleton)({page:b,clientReferenceManifest:I,serverActionsManifest:j});let L=e.method||"GET",D=(0,n.getTracer)(),B=D.getActiveScopeSpan(),F={params:y,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,i)=>k.onRequestError(e,t,a,i,R)},sharedContext:{buildId:v}},M=new l.NodeNextRequest(e),H=new l.NodeNextResponse(t),K=p.NextRequestAdapter.fromNodeNextRequest(M,(0,p.signalFromNodeResponse)(t));try{let o=async e=>k.handle(K,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=D.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${L} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${b}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var n,l;let p=async({previousCacheEntry:r})=>{try{if(!s&&P&&A&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let p=F.renderOpts.collectedTags;if(!$)return await (0,u.sendResponse)(M,H,n,F.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);p&&(t[h.NEXT_CACHE_TAGS_HEADER]=p),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,a=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await k.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:T,isOnDemandRevalidate:P})},!1,R),t}},c=await k.handleResponse({req:e,nextConfig:w,cacheKey:q,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:P,revalidateOnlyGenerated:A,responseGenerator:p,waitUntil:a.waitUntil,isMinimalMode:s});if(!$)return null;if((null==c||null==(n=c.value)?void 0:n.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",P?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&$||f.delete(h.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,g.getCacheControlHeader)(c.cacheControl)),await (0,u.sendResponse)(M,H,new Response(c.value.body,{headers:f,status:c.value.status||200})),null};B?await l(B):await D.withPropagatedContext(e.headers,()=>D.trace(c.BaseServerSpan.handleRequest,{spanName:`${L} ${b}`,kind:n.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await k.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:T,isOnDemandRevalidate:P})},!1,R),$)throw t;return await (0,u.sendResponse)(M,H,new Response(null,{status:500})),null}}e.s(["handler",()=>q,"patchFetch",()=>O,"routeModule",()=>k,"serverHooks",()=>$,"workAsyncStorage",()=>j,"workUnitAsyncStorage",()=>N],87100)},31443,e=>{e.v(e=>Promise.resolve().then(()=>e(75225)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__2dee8ca1._.js.map
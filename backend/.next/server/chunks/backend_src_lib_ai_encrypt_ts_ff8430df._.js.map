{"version":3,"sources":["../../../../backend/src/lib/ai/encrypt.ts"],"sourcesContent":["/**\n * Encrypt/decrypt API keys for AiProviderConfig.\n * Uses AES-256-GCM; key derived from AI_CONFIG_ENCRYPTION_KEY or AUTH_SECRET.\n * Never log or return raw keys.\n */\n\nimport { createCipheriv, createDecipheriv, randomBytes, scryptSync } from 'crypto';\n\nconst ALG = 'aes-256-gcm';\nconst KEY_LEN = 32;\nconst IV_LEN = 16;\nconst TAG_LEN = 16;\n\nfunction getEncryptionKey(): Buffer {\n    const secret = process.env.AI_CONFIG_ENCRYPTION_KEY || process.env.AUTH_SECRET;\n    if (!secret || secret.length < 16) {\n        throw new Error('AI_CONFIG_ENCRYPTION_KEY or AUTH_SECRET (min 16 chars) required for AI config encryption');\n    }\n    return scryptSync(secret, 'ai-config-salt', KEY_LEN);\n}\n\n/**\n * Encrypts a plaintext API key. Returns a hex string: iv:salt:tag:ciphertext (we use fixed salt for key derivation; iv is per-value).\n * For simplicity we store iv+tag+ciphertext as one hex blob (iv 16, tag 16, ciphertext variable).\n */\nexport function encryptApiKey(plaintext: string): string {\n    const key = getEncryptionKey();\n    const iv = randomBytes(IV_LEN);\n    const cipher = createCipheriv(ALG, key, iv);\n    const enc = Buffer.concat([cipher.update(plaintext, 'utf8'), cipher.final()]);\n    const tag = cipher.getAuthTag();\n    return Buffer.concat([iv, tag, enc]).toString('hex');\n}\n\n/**\n * Decrypts an encrypted API key.\n */\nexport function decryptApiKey(encryptedHex: string): string {\n    const key = getEncryptionKey();\n    const buf = Buffer.from(encryptedHex, 'hex');\n    if (buf.length < IV_LEN + TAG_LEN) throw new Error('Invalid encrypted value');\n    const iv = buf.subarray(0, IV_LEN);\n    const tag = buf.subarray(IV_LEN, IV_LEN + TAG_LEN);\n    const ciphertext = buf.subarray(IV_LEN + TAG_LEN);\n    const decipher = createDecipheriv(ALG, key, iv);\n    decipher.setAuthTag(tag);\n    return decipher.update(ciphertext).toString('utf8') + decipher.final('utf8');\n}\n"],"names":[],"mappings":"uCAMA,IAAA,EAAA,EAAA,CAAA,CAAA,OAEA,IAAM,EAAM,cAKZ,SAAS,IACL,IAAM,EAAS,QAAQ,GAAG,CAAC,wBAAwB,EAAI,QAAQ,GAAG,CAAC,WAAW,CAC9E,GAAI,CAAC,GAAU,EAAO,MAAM,CAAG,GAC3B,CAD+B,KACzB,AAAI,MAAM,4FAEpB,MAAO,CAAA,EAAA,EAAA,UAAA,AAAU,EAAC,EAAQ,iBATd,CASgC,EAChD,CAMO,SAAS,EAAc,CAAiB,EAC3C,IAAM,EAAM,IACN,EAAK,CAAA,EAAA,EAAA,WAAA,AAAW,EAAC,IACjB,EAAS,CAAA,EAAA,EAAA,cAAc,AAAd,EAAe,EAAK,EAAK,GAClC,EAAM,OAAO,MAAM,CAAC,CAAC,EAAO,MAAM,CAAC,EAAW,QAAS,EAAO,KAAK,GAAG,EACtE,EAAM,EAAO,UAAU,GAC7B,OAAO,OAAO,MAAM,CAAC,CAAC,EAAI,EAAK,EAAI,EAAE,QAAQ,CAAC,MAClD,CAKO,SAAS,EAAc,CAAoB,EAC9C,IAAM,EAAM,IACN,EAAM,OAAO,IAAI,CAAC,EAAc,OACtC,GAAI,EAAI,MAAM,CAAG,GAAkB,MAAT,AAAe,AAAI,MAAM,2BACnD,IAAM,EAAK,EAAI,QAAQ,CAAC,GAAG,GACrB,EAAM,EAAI,QAAQ,CAAC,AAhCd,GAgCsB,IAC3B,EAAa,EAAI,CADmB,OACX,CAAC,IAC1B,EAAW,CAAA,EADwB,AACxB,EAAA,gBAAA,AAAgB,EAAC,EAAK,EAAK,GAE5C,OADA,EAAS,UAAU,CAAC,GACb,EAAS,MAAM,CAAC,GAAY,QAAQ,CAAC,QAAU,EAAS,KAAK,CAAC,OACzE"}
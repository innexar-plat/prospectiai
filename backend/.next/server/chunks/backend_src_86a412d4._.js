module.exports=[84143,68162,e=>{"use strict";var t=e.i(78787),a=e.i(43757),r=e.i(10266),s=e.i(44730),n=e.i(98936),i=e.i(75225),o=e.i(84680);class l extends Error{status;body;constructor(e,t){super("string"==typeof t.error?t.error:"Request failed"),this.status=e,this.body=t,this.name="SearchHttpError"}}function c(e,t,a){return e.filter(e=>{let r=e.websiteUri||e.website,s=e.nationalPhoneNumber||e.internationalPhoneNumber||e.phone;return("yes"!==t||!!r)&&("no"!==t||!r)&&("yes"!==a||!!s)&&("no"!==a||!s)})}async function u(e,u){let d,{textQuery:p,includedType:g,pageSize:h,pageToken:m,hasWebsite:w,hasPhone:f,city:y,state:S,country:E,radiusKm:P}=e,k=Math.min(a.PLACES_PAGE_SIZE_MAX,Math.max(1,h??a.PLACES_PAGE_SIZE_MAX)),A={includedType:g??null,hasWebsite:w??null,hasPhone:f??null};i.logger.info("Search request",{textQuery:p,includedType:g??null,effectivePageSize:k,hasWebsite:w??null,hasPhone:f??null});let b=await t.prisma.user.findUnique({where:{id:u},select:{onboardingCompletedAt:!0,workspaces:{include:{workspace:!0},take:1}}});if(!b||0===b.workspaces.length)throw new l(404,{error:"Workspace not found"});if(null==b.onboardingCompletedAt)throw new l(403,{error:"Complete onboarding before searching",code:"REQUIRES_ONBOARDING"});let C=b.workspaces[0].workspace;if(C.leadsUsed>=C.leadsLimit)throw new l(403,{error:"Limit reached",code:"LIMIT_EXCEEDED",limit:C.leadsLimit,used:C.leadsUsed});let T=async(e,a)=>{await t.prisma.searchHistory.create({data:{workspaceId:C.id,userId:u,textQuery:p,pageSize:k,filters:A,resultsCount:e,resultsData:a?JSON.parse(JSON.stringify(a)):void 0}}).catch(e=>i.logger.error("SearchHistory create error",{error:e instanceof Error?e.message:"Unknown"}))};if(!m){let e=`search:${p}:${g||""}:${k}:${w||"any"}:${f||"any"}`,a=await (0,s.getCached)(e),r=a?.places?.length??0,n=Math.min(5,k);if(r>=n)return i.logger.info("Search: cache hit",{cachedCount:r}),await T(r,a.places),{...a,fromCache:!0};r>0&&i.logger.info("Search: cache skipped (below minimum)",{cachedCount:r,minAcceptableFromCache:n});let o=await t.prisma.lead.findMany({where:{OR:[{name:{contains:p,mode:"insensitive"}},{address:{contains:p,mode:"insensitive"}}]},take:100,orderBy:{lastSearchedAt:"desc"}});if(o.length>=10){let e=c(o.map(e=>({id:e.placeId,displayName:{text:e.name},formattedAddress:e.address,nationalPhoneNumber:e.phone,websiteUri:e.website,rating:e.rating,userRatingCount:e.reviewCount,types:e.types,businessStatus:e.businessStatus})),w,f),t=e.slice(0,k);if(t.length>=5)return i.logger.info("Search: local DB used",{dbTotal:o.length,afterFilter:e.length,returned:t.length}),await T(t.length,t),{places:t,fromLocalDb:!0}}i.logger.info("Search: local DB skip",{dbLeadsCount:o.length})}let _=y?.trim();if(_&&!m){let e=await (0,r.geocodeAddress)(_,S??null,E??"Brasil");if(e){let t=P??15,a=Math.min(5e4,Math.round(1e3*t)||Math.round(15e3));d={center:e,radius:a},i.logger.info("Search: locationBias applied",{city:_,radiusKm:t,radiusM:a})}else i.logger.info("Search: geocode failed, no locationBias",{city:_})}m&&await new Promise(e=>setTimeout(e,400)),i.logger.info("Search: calling Google Places API",{textQuery:p,includedType:g??null,hasLocationBias:!!d,hasPageToken:!!m});let L=await (0,a.textSearch)({textQuery:p,includedType:g||void 0,pageSize:k,pageToken:m||void 0,locationBias:d}),I=L.places?.length??0;L.places&&(L.places=c(L.places,w,f).slice(0,k));let O=L.places?.length??0;return i.logger.info("Search: Google Places response",{rawCount:I,afterFilter:O,hasWebsite:w??null,hasPhone:f??null}),L.places&&L.places.length>0&&((0,o.recordUsageEvent)({workspaceId:C.id,userId:u,type:"GOOGLE_PLACES_SEARCH",quantity:1}),(0,n.syncLeads)(L.places).catch(e=>i.logger.error("Background sync error",{error:e instanceof Error?e.message:"Unknown"})),await t.prisma.$transaction([t.prisma.workspace.update({where:{id:C.id},data:{leadsUsed:{increment:1}}}),t.prisma.searchHistory.create({data:{workspaceId:C.id,userId:u,textQuery:p,pageSize:k,filters:A,resultsCount:L.places.length,resultsData:JSON.parse(JSON.stringify(L.places))}})])),i.logger.info("Search: result",{resultCount:O}),L}async function d(e,s,u){let d,{textQuery:p,includedType:g,hasWebsite:h,hasPhone:m,city:w,state:f,country:y,radiusKm:S}=e,E=Math.min(u,60),P=await t.prisma.user.findUnique({where:{id:s},select:{onboardingCompletedAt:!0,workspaces:{include:{workspace:!0},take:1}}});if(!P||0===P.workspaces.length)throw new l(404,{error:"Workspace not found"});if(null==P.onboardingCompletedAt)throw new l(403,{error:"Complete onboarding before searching",code:"REQUIRES_ONBOARDING"});let k=P.workspaces[0].workspace;if(k.leadsUsed>=k.leadsLimit)throw new l(403,{error:"Limit reached",code:"LIMIT_EXCEEDED",limit:k.leadsLimit,used:k.leadsUsed});let A=w?.trim();if(A){let e=await (0,r.geocodeAddress)(A,f??null,y??"Brasil");if(e){let t=Math.min(5e4,Math.round((S??15)*1e3)||Math.round(15e3));d={center:e,radius:t},i.logger.info("SearchAllPages: locationBias applied",{city:A,radiusM:t})}}i.logger.info("SearchAllPages: fetching up to N places",{textQuery:p,effectiveMax:E});let{places:b}=await (0,a.textSearchAllPages)({textQuery:p,includedType:g||void 0,locationBias:d,maxPlaces:E}),C=c(b,h,m).slice(0,E),T=C.length;return C.length>0&&((0,o.recordUsageEvent)({workspaceId:k.id,userId:s,type:"GOOGLE_PLACES_SEARCH",quantity:1}),(0,n.syncLeads)(C).catch(e=>i.logger.error("Background sync error",{error:e instanceof Error?e.message:"Unknown"})),await t.prisma.$transaction([t.prisma.workspace.update({where:{id:k.id},data:{leadsUsed:{increment:1}}}),t.prisma.searchHistory.create({data:{workspaceId:k.id,userId:s,textQuery:p,pageSize:E,filters:{includedType:g??null,hasWebsite:h??null,hasPhone:m??null},resultsCount:T,resultsData:JSON.parse(JSON.stringify(C))}})])),i.logger.info("SearchAllPages: result",{totalFetched:T}),{places:C,totalFetched:T}}e.s(["SEARCH_ALL_PAGES_MAX_PLACES",0,60,"SearchHttpError",()=>l,"runSearch",()=>u,"runSearchAllPages",()=>d],68162),e.s([],84143)},98936,e=>{"use strict";var t=e.i(78787);async function a(a){try{return await t.prisma.lead.upsert({where:{placeId:a.id},update:{name:a.displayName.text,address:a.formattedAddress,phone:a.nationalPhoneNumber||a.internationalPhoneNumber,website:a.websiteUri,rating:a.rating,reviewCount:a.userRatingCount,types:a.types||[],businessStatus:a.businessStatus,lastSearchedAt:new Date},create:{placeId:a.id,name:a.displayName.text,address:a.formattedAddress,phone:a.nationalPhoneNumber||a.internationalPhoneNumber,website:a.websiteUri,rating:a.rating,reviewCount:a.userRatingCount,types:a.types||[],businessStatus:a.businessStatus}})}catch(r){let{logger:t}=await e.A(31443);return t.error("Error syncing lead",{placeId:a.id,error:r instanceof Error?r.message:"Unknown"}),null}}async function r(e){return Promise.all(e.map(a))}e.s(["syncLead",()=>a,"syncLeads",()=>r])},44730,e=>{"use strict";var t=e.i(42512);let a=null;function r(){if(a)return a;let e=process.env.REDIS_URL||"redis://localhost:6379";try{return(a=new t.default(e,{maxRetriesPerRequest:1,retryStrategy:e=>e>2?null:Math.min(200*e,1e3),lazyConnect:!0})).on("error",()=>{a=null}),a}catch{return null}}async function s(e){try{let t=r();if(!t)return null;await t.connect().catch(()=>{});let a=await t.get(e);if(!a)return null;return JSON.parse(a)}catch{return null}}async function n(e,t,a=300){try{let s=r();if(!s)return;await s.connect().catch(()=>{}),await s.set(e,JSON.stringify(t),"EX",a)}catch{}}e.s(["getCached",()=>s,"setCached",()=>n])},84680,e=>{"use strict";var t=e.i(78787);function a(a){let{workspaceId:r,userId:s,type:n,quantity:i=1,metadata:o}=a;t.prisma.usageEvent.create({data:{workspaceId:r,userId:s??void 0,type:n,quantity:i,metadata:o||void 0}}).catch(t=>{e.A(31443).then(({logger:e})=>e.warn("Usage event record failed",{workspaceId:r,type:n,error:t instanceof Error?t.message:"Unknown"}))})}async function r(e){if(0===e.length)return new Map;let a={googlePlacesSearch:0,googlePlacesDetails:0,serperRequests:0,aiInputTokens:0,aiOutputTokens:0},r=new Map(e.map(e=>[e,{...a}]));for(let a of(await t.prisma.usageEvent.groupBy({by:["workspaceId","type"],where:{workspaceId:{in:e},type:{not:"AI_TOKENS"}},_sum:{quantity:!0}}))){let e=r.get(a.workspaceId),t=a._sum.quantity??0;"GOOGLE_PLACES_SEARCH"===a.type?e.googlePlacesSearch=t:"GOOGLE_PLACES_DETAILS"===a.type?e.googlePlacesDetails=t:"SERPER_REQUEST"===a.type&&(e.serperRequests=t)}for(let a of(await t.prisma.usageEvent.findMany({where:{workspaceId:{in:e},type:"AI_TOKENS"},select:{workspaceId:!0,metadata:!0}}))){let e=r.get(a.workspaceId),t=a.metadata;t&&(e.aiInputTokens+=Number(t.inputTokens)||0,e.aiOutputTokens+=Number(t.outputTokens)||0)}return r}e.s(["getWorkspaceUsage",()=>r,"recordUsageEvent",()=>a])},43757,49292,e=>{"use strict";function t(e){return new Promise(t=>setTimeout(t,e))}let a=e=>429===e||e>=500&&e<600;async function r(e,s,n={}){let{timeoutMs:i=15e3,maxRetries:o=3,initialBackoffMs:l=1e3,retryStatuses:c=a}=n,u=null,d=null;for(let a=0;a<=o;a++){let r=new AbortController,n=setTimeout(()=>r.abort(),i),p={...s,signal:r.signal};try{let r=await fetch(e,p);if(clearTimeout(n),u=r,a<o&&c(r.status)){let e=l*Math.pow(2,a);await t(e);continue}return r}catch(e){if(clearTimeout(n),d=e instanceof Error?e:Error(String(e)),a<o){let e=l*Math.pow(2,a);await t(e);continue}throw d}}if(u)return u;throw d??Error("fetchWithRetry failed")}e.s(["fetchWithRetry",()=>r],49292);let s="https://places.googleapis.com/v1/places",n=new Map;async function i(e){let t,a=process.env.GOOGLE_PLACES_API_KEY;if(!a)throw Error("GOOGLE_PLACES_API_KEY not configured");let i=Math.min(20,Math.max(1,e.pageSize??20));if(e.pageToken){let a=n.get(e.pageToken);t=a?{...a.body,pageToken:e.pageToken}:{textQuery:e.textQuery,pageSize:i,languageCode:e.languageCode||"pt-BR",regionCode:e.regionCode||"BR",pageToken:e.pageToken}}else if(t={textQuery:e.textQuery,pageSize:i,languageCode:e.languageCode||"pt-BR",regionCode:e.regionCode||"BR"},e.includedType&&(t.includedType=e.includedType),e.locationBias?.center&&e.locationBias?.radius!=null){let a=Math.min(5e4,Math.max(0,e.locationBias.radius));t.locationBias={circle:{center:{latitude:e.locationBias.center.latitude,longitude:e.locationBias.center.longitude},radius:a}}}let o=await r(`${s}:searchText`,{method:"POST",headers:{"Content-Type":"application/json","X-Goog-Api-Key":a,"X-Goog-FieldMask":"places.id,places.displayName,places.formattedAddress,places.nationalPhoneNumber,places.internationalPhoneNumber,places.websiteUri,places.googleMapsUri,places.rating,places.userRatingCount,places.types,places.businessStatus,places.primaryType,places.primaryTypeDisplayName,nextPageToken"},body:JSON.stringify(t)},{timeoutMs:15e3,maxRetries:3});if(!o.ok){let e=await o.text();throw Error(`Places API error (${o.status}): ${e}`)}let l=await o.json();if(l.nextPageToken){let e={...t};delete e.pageToken,n.set(l.nextPageToken,{body:e,ts:Date.now()}),n.size>50&&function(){let e=Date.now();for(let[t,a]of n)e-a.ts>6e5&&n.delete(t)}()}return{places:l.places||[],nextPageToken:l.nextPageToken}}async function o(e){let t,{maxPlaces:a,...r}=e,s=Math.max(1,Math.min(a,60)),n=[];for(;n.length<s;){let e=await i({...r,pageSize:Math.min(20,s-n.length),pageToken:t,locationBias:t?void 0:r.locationBias}),a=e.places??[];if(n.push(...a),0===a.length||!e.nextPageToken||n.length>=s)break;t=e.nextPageToken,await new Promise(e=>setTimeout(e,400))}return{places:n.slice(0,s)}}async function l(e){let t=process.env.GOOGLE_PLACES_API_KEY;if(!t)throw Error("GOOGLE_PLACES_API_KEY not configured");let a=await r(`${s}/${e}`,{method:"GET",headers:{"X-Goog-Api-Key":t,"X-Goog-FieldMask":"id,displayName,formattedAddress,nationalPhoneNumber,internationalPhoneNumber,websiteUri,googleMapsUri,rating,userRatingCount,types,businessStatus,currentOpeningHours,reviews,primaryType,primaryTypeDisplayName"}},{timeoutMs:15e3,maxRetries:2});if(!a.ok){let e=await a.text();throw Error(`Place Details error (${a.status}): ${e}`)}return await a.json()}e.s(["PLACES_PAGE_SIZE_MAX",0,20,"getPlaceDetails",()=>l,"textSearch",()=>i,"textSearchAllPages",()=>o],43757)},10266,e=>{"use strict";var t=e.i(49292);async function a(e,r,s="Brasil"){let n,i=process.env.GOOGLE_PLACES_API_KEY;if(!i)return null;let o=[e.trim()];r?.trim()&&o.push(r.trim()),o.push(s);let l=o.join(", "),c=(n=s.trim().toLowerCase()).includes("brasil")||"br"===n?"br":n.includes("argentina")||"ar"===n?"ar":n.includes("mÃ©xico")||n.includes("mexico")||"mx"===n?"mx":n.includes("estados unidos")||n.includes("united states")||"us"===n?"us":n.includes("portugal")||"pt"===n?"pt":n.includes("espanha")||n.includes("spain")||"es"===n?"es":"br",u=new URL("https://maps.googleapis.com/maps/api/geocode/json");u.searchParams.set("address",l),u.searchParams.set("key",i),u.searchParams.set("region",c),u.searchParams.set("language","pt-BR");let d=await (0,t.fetchWithRetry)(u.toString(),{method:"GET"},{timeoutMs:1e4,maxRetries:2});if(!d.ok)return null;let p=await d.json();if("OK"!==p.status||!p.results?.[0]?.geometry?.location)return null;let g=p.results[0].geometry.location,h=g.lat,m=g.lng;return"number"!=typeof h||"number"!=typeof m?null:{latitude:h,longitude:m}}e.s(["geocodeAddress",()=>a])}];

//# sourceMappingURL=backend_src_86a412d4._.js.map
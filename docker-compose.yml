services:
  # ── Frontend: novo domínio prospectorai.innexar.com.br → este container:5173 ──
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: prospector-frontend
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "5173:5173"
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - prospector-net
      - fixelo-network
    labels:
      - "traefik.enable=true"
      # Rede usada pelo Traefik para alcançar este container
      - "traefik.docker.network=fixelo_fixelo-network"
      # Serviço: este container na porta 5173
      - "traefik.http.services.prospector-ai-frontend.loadbalancer.server.port=5173"
      - "traefik.http.services.prospector-ai-frontend.loadbalancer.passHostHeader=true"
      # Roteador HTTPS — novo domínio → frontend
      - "traefik.http.routers.prospector-ai.rule=Host(`prospectorai.innexar.com.br`)"
      - "traefik.http.routers.prospector-ai.entrypoints=websecure"
      - "traefik.http.routers.prospector-ai.tls.certresolver=letsencrypt"
      - "traefik.http.routers.prospector-ai.service=prospector-ai-frontend"
      - "traefik.http.routers.prospector-ai.priority=100"
      # HTTP → HTTPS redirect
      - "traefik.http.middlewares.redirect-to-https-prospector.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https-prospector.redirectscheme.permanent=true"
      - "traefik.http.routers.prospector-ai-http.rule=Host(`prospectorai.innexar.com.br`)"
      - "traefik.http.routers.prospector-ai-http.entrypoints=web"
      - "traefik.http.routers.prospector-ai-http.middlewares=redirect-to-https-prospector"
      - "traefik.http.routers.prospector-ai-http.service=prospector-ai-frontend"
      - "traefik.http.routers.prospector-ai-http.priority=100"
      # 301 domínio antigo (busca) → novo
      - "traefik.http.middlewares.redirect-busca-to-prospectorai.redirectregex.regex=^https?:\\/\\/busca\\.innexar\\.com\\.br(.*)"
      - "traefik.http.middlewares.redirect-busca-to-prospectorai.redirectregex.replacement=https://prospectorai.innexar.com.br$${1}"
      - "traefik.http.middlewares.redirect-busca-to-prospectorai.redirectregex.permanent=true"
      - "traefik.http.routers.prospector-ai-busca.rule=Host(`busca.innexar.com.br`)"
      - "traefik.http.routers.prospector-ai-busca.entrypoints=websecure"
      - "traefik.http.routers.prospector-ai-busca.tls.certresolver=letsencrypt"
      - "traefik.http.routers.prospector-ai-busca.service=prospector-ai-frontend"
      - "traefik.http.routers.prospector-ai-busca.middlewares=redirect-busca-to-prospectorai"
      - "traefik.http.routers.prospector-ai-busca-http.rule=Host(`busca.innexar.com.br`)"
      - "traefik.http.routers.prospector-ai-busca-http.entrypoints=web"
      - "traefik.http.routers.prospector-ai-busca-http.service=prospector-ai-frontend"
      - "traefik.http.routers.prospector-ai-busca-http.middlewares=redirect-busca-to-prospectorai"

  # ── Admin: painel admin com hot reload (porta 5174) ───────────────────────────
  admin:
    build:
      context: ./admin
      dockerfile: Dockerfile.dev
    container_name: prospector-admin
    volumes:
      - ./admin:/app
      - /app/node_modules
    ports:
      - "5174:5174"
    environment:
      - VITE_API_TARGET=http://backend:4000
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - prospector-net
      - fixelo-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=fixelo_fixelo-network"
      - "traefik.http.services.prospector-ai-admin.loadbalancer.server.port=5174"
      - "traefik.http.services.prospector-ai-admin.loadbalancer.passHostHeader=true"
      # Redirect /admin → /admin/ (evita acesso negado por path sem barra)
      - "traefik.http.middlewares.admin-add-slash.redirectregex.regex=^https://([^/]+)/admin$$"
      - "traefik.http.middlewares.admin-add-slash.redirectregex.replacement=https://$${1}/admin/"
      - "traefik.http.middlewares.admin-add-slash.redirectregex.permanent=true"
      # /admin (exato) → redirect acima
      - "traefik.http.routers.prospector-ai-admin-redirect.rule=Host(`prospectorai.innexar.com.br`) && Path(`/admin`)"
      - "traefik.http.routers.prospector-ai-admin-redirect.entrypoints=websecure"
      - "traefik.http.routers.prospector-ai-admin-redirect.tls.certresolver=letsencrypt"
      - "traefik.http.routers.prospector-ai-admin-redirect.middlewares=admin-add-slash"
      - "traefik.http.routers.prospector-ai-admin-redirect.service=prospector-ai-admin"
      - "traefik.http.routers.prospector-ai-admin-redirect.priority=210"
      # /admin/ no mesmo domínio → container admin (prioridade maior que o frontend)
      - "traefik.http.routers.prospector-ai-admin.rule=Host(`prospectorai.innexar.com.br`) && (PathPrefix(`/admin/`) || PathPrefix(`/admin`))"
      - "traefik.http.routers.prospector-ai-admin.entrypoints=websecure"
      - "traefik.http.routers.prospector-ai-admin.tls.certresolver=letsencrypt"
      - "traefik.http.routers.prospector-ai-admin.service=prospector-ai-admin"
      - "traefik.http.routers.prospector-ai-admin.priority=200"
      - "traefik.http.routers.prospector-ai-admin-http.rule=Host(`prospectorai.innexar.com.br`) && PathPrefix(`/admin`)"
      - "traefik.http.routers.prospector-ai-admin-http.entrypoints=web"
      - "traefik.http.routers.prospector-ai-admin-http.middlewares=redirect-to-https-prospector"
      - "traefik.http.routers.prospector-ai-admin-http.service=prospector-ai-admin"
      - "traefik.http.routers.prospector-ai-admin-http.priority=200"

  # ── Backend: Next.js API-only ─────────────────────────────────────────────────
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_MERCADOPAGO_PUBLIC_KEY=${NEXT_PUBLIC_MERCADOPAGO_PUBLIC_KEY}
        - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
    container_name: prospector-backend
    env_file:
      - .env
    environment:
      - FRONTEND_URL=https://prospectorai.innexar.com.br
      - ADMIN_EMAILS=${ADMIN_EMAILS}
      - SUPPORT_EMAILS=${SUPPORT_EMAILS:-}
    ports:
      - "3010:4000"
    depends_on:
      - redis
      - db
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:4000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - prospector-net
    # Em produção o Traefik não usa esta porta; o frontend faz proxy de /api/* para backend:4000.
    # A porta 3010 é para health check local (make health) e acesso direto à API em dev.

  # ── Redis ─────────────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: prospector-redis
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - prospector-net

  # ── PostgreSQL ────────────────────────────────────────────────────────────────
  db:
    image: postgres:16-alpine
    container_name: prospector-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-prospector}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-prospector123}
      POSTGRES_DB: ${POSTGRES_DB:-prospector_db}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    restart: unless-stopped
    networks:
      prospector-net:
        aliases:
          - prospector-db

networks:
  prospector-net:
    driver: bridge
  fixelo-network:
    external: true
    name: fixelo_fixelo-network

volumes:
  redis-data:
  postgres-data:
